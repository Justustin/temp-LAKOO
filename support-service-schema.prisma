// =============================================================================
// SUPPORT SERVICE DATABASE SCHEMA
// Service: support-service (Port 3014)
// Database: support_db
// Owner: Support tickets, messages, agents, canned responses, SLA tracking
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("SUPPORT_DATABASE_URL")
}

// =============================================================================
// SUPPORT TICKETS
// =============================================================================

model SupportTicket {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketNumber    String         @unique @db.VarChar(50) // TKT-20260115-XXXXX
  userId          String         @db.Uuid // Reference to Auth Service
  // Customer snapshot
  customerName    String         @db.VarChar(255)
  customerEmail   String?        @db.VarChar(255)
  customerPhone   String         @db.VarChar(20)
  // Ticket details
  subject         String         @db.VarChar(255)
  description     String
  category        TicketCategory
  priority        TicketPriority @default(medium)
  // Related entities
  orderId         String?        @db.Uuid
  orderNumber     String?        @db.VarChar(50)
  productId       String?        @db.Uuid
  sellerId        String?        @db.Uuid
  // Source
  source          TicketSource   @default(web)
  // Assignment
  assignedAgentId String?        @db.Uuid
  assignedTeam    String?        @db.VarChar(100)
  assignedAt      DateTime?      @db.Timestamptz(6)
  // Status
  status          TicketStatus   @default(open)
  // SLA tracking
  slaDeadline     DateTime?      @db.Timestamptz(6)
  slaBreached     Boolean        @default(false)
  slaBreachedAt   DateTime?      @db.Timestamptz(6)
  // Resolution
  resolution      String?
  resolvedAt      DateTime?      @db.Timestamptz(6)
  resolvedBy      String?        @db.Uuid
  // Satisfaction
  satisfactionRating Int?        // 1-5
  satisfactionComment String?
  ratedAt         DateTime?      @db.Timestamptz(6)
  // Timestamps
  firstResponseAt DateTime?      @db.Timestamptz(6)
  lastActivityAt  DateTime       @default(now()) @db.Timestamptz(6)
  closedAt        DateTime?      @db.Timestamptz(6)
  reopenedAt      DateTime?      @db.Timestamptz(6)
  reopenCount     Int            @default(0)
  createdAt       DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime       @updatedAt @db.Timestamptz(6)

  messages    TicketMessage[]
  attachments TicketAttachment[]
  history     TicketHistory[]
  tags        TicketTag[]

  @@index([ticketNumber])
  @@index([userId])
  @@index([orderId])
  @@index([assignedAgentId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
  @@map("support_ticket")
}

model TicketMessage {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId    String      @db.Uuid
  // Sender
  senderType  SenderType
  senderId    String?     @db.Uuid // User ID or Agent ID
  senderName  String      @db.VarChar(255)
  // Content
  message     String
  isInternal  Boolean     @default(false) // Internal notes (not visible to customer)
  // Email tracking (if sent via email)
  emailMessageId String?  @db.VarChar(255)
  // Read status
  isRead      Boolean     @default(false)
  readAt      DateTime?   @db.Timestamptz(6)
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)

  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  attachments MessageAttachment[]

  @@index([ticketId])
  @@index([senderType])
  @@index([createdAt])
  @@map("ticket_message")
}

model TicketAttachment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId    String   @db.Uuid
  fileName    String   @db.VarChar(255)
  fileUrl     String
  fileSize    Int      // Bytes
  mimeType    String   @db.VarChar(100)
  uploadedBy  String?  @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_attachment")
}

model MessageAttachment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId   String   @db.Uuid
  fileName    String   @db.VarChar(255)
  fileUrl     String
  fileSize    Int
  mimeType    String   @db.VarChar(100)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  message TicketMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_attachment")
}

model TicketHistory {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId    String   @db.Uuid
  action      String   @db.VarChar(100) // "created", "assigned", "status_changed", etc.
  field       String?  @db.VarChar(100)
  oldValue    String?
  newValue    String?
  performedBy String?  @db.Uuid
  performedByType String? @db.VarChar(50) // "customer", "agent", "system"
  notes       String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
  @@map("ticket_history")
}

model TicketTag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId  String   @db.Uuid
  tag       String   @db.VarChar(50)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, tag])
  @@index([tag])
  @@map("ticket_tag")
}

// =============================================================================
// SUPPORT AGENTS
// =============================================================================

model SupportAgent {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String       @unique @db.Uuid // Reference to Auth Service
  agentCode       String       @unique @db.VarChar(50)
  displayName     String       @db.VarChar(255)
  email           String       @db.VarChar(255)
  // Role
  role            AgentRole    @default(agent)
  team            String?      @db.VarChar(100)
  // Skills/specializations
  skills          String[]     // Categories they can handle
  languages       String[]     // Languages they speak
  // Capacity
  maxActiveTickets Int         @default(10)
  currentTickets  Int          @default(0)
  // Availability
  status          AgentStatus  @default(offline)
  isAvailable     Boolean      @default(false)
  lastActiveAt    DateTime?    @db.Timestamptz(6)
  // Performance metrics (aggregated)
  totalTicketsHandled Int      @default(0)
  avgResponseTime Int?         // Seconds
  avgResolutionTime Int?       // Seconds
  avgSatisfactionRating Decimal? @db.Decimal(3, 2)
  // Audit
  createdAt       DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @db.Timestamptz(6)
  deletedAt       DateTime?    @db.Timestamptz(6)

  @@index([agentCode])
  @@index([status])
  @@index([team])
  @@index([deletedAt])
  @@map("support_agent")
}

// =============================================================================
// CANNED RESPONSES
// =============================================================================

model CannedResponse {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String   @db.VarChar(255)
  shortcut    String?  @db.VarChar(50) // Quick access code
  content     String
  // Categorization
  category    String?  @db.VarChar(100)
  tags        String[]
  // Usage
  usageCount  Int      @default(0)
  lastUsedAt  DateTime? @db.Timestamptz(6)
  // Visibility
  isGlobal    Boolean  @default(true) // Available to all agents
  createdBy   String?  @db.Uuid // If not global, owner agent
  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@index([shortcut])
  @@index([category])
  @@index([isActive])
  @@map("canned_response")
}

// =============================================================================
// SLA CONFIGURATION
// =============================================================================

model SlaPolicy {
  id                  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String         @db.VarChar(255)
  description         String?
  // Conditions
  priority            TicketPriority
  category            TicketCategory?
  // Response time (minutes)
  firstResponseTime   Int            // Target first response
  resolutionTime      Int            // Target resolution
  // Business hours
  useBusinessHours    Boolean        @default(true)
  businessHoursStart  String?        @db.VarChar(5) // "09:00"
  businessHoursEnd    String?        @db.VarChar(5) // "18:00"
  businessDays        String[]       // ["monday", "tuesday", ...]
  timezone            String         @default("Asia/Jakarta") @db.VarChar(50)
  // Status
  isActive            Boolean        @default(true)
  isDefault           Boolean        @default(false)
  createdAt           DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime       @updatedAt @db.Timestamptz(6)

  @@index([priority])
  @@index([isActive])
  @@map("sla_policy")
}

// =============================================================================
// LIVE CHAT SESSIONS
// =============================================================================

model ChatSession {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?       @db.Uuid
  visitorId       String?       @db.VarChar(100) // For non-logged in users
  ticketId        String?       @db.Uuid // If converted to ticket
  agentId         String?       @db.Uuid
  // Visitor info
  visitorName     String?       @db.VarChar(255)
  visitorEmail    String?       @db.VarChar(255)
  // Context
  pageUrl         String?       @db.VarChar(500)
  referrer        String?       @db.VarChar(500)
  userAgent       String?
  ipAddress       String?       @db.VarChar(45)
  // Status
  status          ChatStatus    @default(waiting)
  // Timestamps
  startedAt       DateTime      @default(now()) @db.Timestamptz(6)
  assignedAt      DateTime?     @db.Timestamptz(6)
  endedAt         DateTime?     @db.Timestamptz(6)
  // Metrics
  waitTimeSeconds Int?
  durationSeconds Int?
  messageCount    Int           @default(0)
  // Rating
  rating          Int?
  ratingComment   String?
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @db.Timestamptz(6)

  messages ChatMessage[]

  @@index([userId])
  @@index([agentId])
  @@index([status])
  @@index([startedAt])
  @@map("chat_session")
}

model ChatMessage {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId   String     @db.Uuid
  senderType  SenderType
  senderId    String?    @db.Uuid
  senderName  String     @db.VarChar(255)
  message     String
  // Attachments
  attachments Json?      // Array of {url, name, size, type}
  // Status
  isRead      Boolean    @default(false)
  readAt      DateTime?  @db.Timestamptz(6)
  createdAt   DateTime   @default(now()) @db.Timestamptz(6)

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_message")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100)
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum TicketCategory {
  order_issue
  payment_issue
  shipping_issue
  return_refund
  product_inquiry
  account_issue
  technical_issue
  seller_complaint
  feedback
  // Content moderation (social commerce)
  content_report        // Reported posts/comments
  copyright_claim       // Copyright/IP violations
  spam_report           // Spam content
  harassment_report     // Harassment/bullying
  creator_support       // Content creator issues
  other
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketSource {
  web
  mobile_app
  email
  live_chat
  phone
  social_media
  whatsapp
}

enum TicketStatus {
  open
  in_progress
  waiting_customer
  waiting_internal
  resolved
  closed
  reopened
}

enum SenderType {
  customer
  agent
  system
  bot
}

enum AgentRole {
  agent
  senior_agent
  team_lead
  supervisor
  manager
}

enum AgentStatus {
  online
  busy
  away
  offline
}

enum ChatStatus {
  waiting
  active
  ended
  missed
  transferred
}
