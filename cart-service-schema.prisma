// =============================================================================
// CART SERVICE DATABASE SCHEMA
// Service: cart-service (Port 3003)
// Database: cart_db
// Owner: Shopping carts, cart items, price snapshots
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("CART_DATABASE_URL")
}

// =============================================================================
// SHOPPING CART
// =============================================================================

model Cart {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String?    @map("user_id") @db.Uuid // Null for guest carts
  sessionId      String?    @map("session_id") @db.VarChar(100) // For guest identification
  status         CartStatus @default(active)
  currency       String     @default("IDR") @db.VarChar(3)
  // Cached totals (recalculated on item changes)
  itemCount      Int        @default(0) @map("item_count")
  subtotal       Decimal    @default(0) @db.Decimal(15, 2)
  // Discount tracking (from Promotion Service)
  couponCode     String?    @map("coupon_code") @db.VarChar(50)
  couponId       String?    @map("coupon_id") @db.Uuid
  discountAmount Decimal    @default(0) @map("discount_amount") @db.Decimal(15, 2)
  // Expiration
  expiresAt      DateTime?  @map("expires_at") @db.Timestamptz(6) // Auto-clear after 30 days
  lastActivityAt DateTime   @default(now()) @map("last_activity_at") @db.Timestamptz(6)
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  items CartItem[]

  @@unique([userId]) // One active cart per user
  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@index([expiresAt])
  @@map("cart")
}

model CartItem {
  id                   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cartId               String       @map("cart_id") @db.Uuid
  itemType             CartItemType @default(brand_product) @map("item_type")
  // Product references (from Product Service)
  productId            String?      @map("product_id") @db.Uuid
  variantId            String?      @map("variant_id") @db.Uuid
  // Brand reference (from Brand Service)
  brandId              String?      @map("brand_id") @db.Uuid
  brandProductId       String?      @map("brand_product_id") @db.Uuid // BrandProduct assignment ID
  // Seller reference (from Seller Service)
  sellerProductId      String?      @map("seller_product_id") @db.Uuid
  sellerId             String?      @map("seller_id") @db.Uuid
  // Quantity
  quantity             Int          @default(1)
  // ==========================================================================
  // PRICE SNAPSHOT (captured at add-to-cart time)
  // This is CRITICAL for the multi-brand pricing model
  // ==========================================================================
  snapshotProductName  String       @map("snapshot_product_name") @db.VarChar(255)
  snapshotVariantName  String?      @map("snapshot_variant_name") @db.VarChar(255)
  snapshotSku          String?      @map("snapshot_sku") @db.VarChar(100)
  snapshotImageUrl     String?      @map("snapshot_image_url")
  snapshotUnitPrice    Decimal      @map("snapshot_unit_price") @db.Decimal(15, 2) // Price at time of add
  snapshotComparePrice Decimal?     @map("snapshot_compare_price") @db.Decimal(15, 2)
  snapshotBrandName    String?      @map("snapshot_brand_name") @db.VarChar(255)
  snapshotSellerName   String?      @map("snapshot_seller_name") @db.VarChar(255)
  // ==========================================================================
  // Current price (refreshed periodically and at checkout)
  currentUnitPrice     Decimal      @map("current_unit_price") @db.Decimal(15, 2)
  priceChanged         Boolean      @default(false) @map("price_changed") // Flag if price differs from snapshot
  priceLastCheckedAt   DateTime     @default(now()) @map("price_last_checked_at") @db.Timestamptz(6)
  // Availability status
  isAvailable          Boolean      @default(true) @map("is_available")
  availabilityMessage  String?      @map("availability_message") @db.VarChar(255)
  // Timestamps
  addedAt              DateTime     @default(now()) @map("added_at") @db.Timestamptz(6)
  updatedAt            DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([productId])
  @@index([brandId])
  @@index([sellerId])
  @@map("cart_item")
}

// =============================================================================
// SAVED FOR LATER (Items removed from cart but saved)
// =============================================================================

model SavedForLater {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String   @map("user_id") @db.Uuid
  productId           String   @map("product_id") @db.Uuid
  variantId           String?  @map("variant_id") @db.Uuid
  brandId             String?  @map("brand_id") @db.Uuid
  brandProductId      String?  @map("brand_product_id") @db.Uuid
  sellerProductId     String?  @map("seller_product_id") @db.Uuid
  sellerId            String?  @map("seller_id") @db.Uuid
  // Snapshot
  snapshotProductName String   @map("snapshot_product_name") @db.VarChar(255)
  snapshotImageUrl    String?  @map("snapshot_image_url")
  snapshotUnitPrice   Decimal  @map("snapshot_unit_price") @db.Decimal(15, 2)
  savedAt             DateTime @default(now()) @map("saved_at") @db.Timestamptz(6)

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@map("saved_for_later")
}

// =============================================================================
// ABANDONED CART TRACKING
// =============================================================================

model AbandonedCartEvent {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cartId         String    @map("cart_id") @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  email          String?   @db.VarChar(255) // For notification
  cartValue      Decimal   @map("cart_value") @db.Decimal(15, 2)
  itemCount      Int       @map("item_count")
  abandonedAt    DateTime  @default(now()) @map("abandoned_at") @db.Timestamptz(6)
  // Recovery tracking
  reminderSentAt DateTime? @map("reminder_sent_at") @db.Timestamptz(6)
  reminderCount  Int       @default(0) @map("reminder_count")
  recoveredAt    DateTime? @map("recovered_at") @db.Timestamptz(6)
  orderId        String?   @map("order_id") @db.Uuid // If recovered

  @@index([cartId])
  @@index([userId])
  @@index([abandonedAt])
  @@map("abandoned_cart_event")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(100)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum CartStatus {
  active
  merged        // Guest cart merged with user cart
  converted     // Converted to order
  abandoned
  expired
}

enum CartItemType {
  brand_product   // From LAKOO brands (warehouse)
  seller_product  // From third-party sellers
}
