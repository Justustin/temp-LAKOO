// =============================================================================
// ADVERTISEMENT SERVICE DATABASE SCHEMA
// Service: advertisement-service (Port 3013)
// Database: ad_db
// Owner: Ad campaigns, impressions, clicks, conversions, banner ads, seller ad balances
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("AD_DATABASE_URL")
}

// =============================================================================
// SELLER AD BALANCE
// =============================================================================

model SellerAdBalance {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId        String   @unique @db.Uuid // Reference to Seller Service
  // Balances
  balance         Decimal  @default(0) @db.Decimal(15, 2)
  pendingBalance  Decimal  @default(0) @db.Decimal(15, 2)
  // Lifetime totals
  totalDeposited  Decimal  @default(0) @db.Decimal(15, 2)
  totalSpent      Decimal  @default(0) @db.Decimal(15, 2)
  totalRefunded   Decimal  @default(0) @db.Decimal(15, 2)
  // Status
  status          BalanceStatus @default(active)
  // Optimistic locking
  version         Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  transactions AdBalanceTransaction[]

  @@map("seller_ad_balance")
}

model AdBalanceTransaction {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  balanceId       String        @db.Uuid
  sellerId        String        @db.Uuid
  type            AdBalanceTxType
  amount          Decimal       @db.Decimal(15, 2)
  balanceBefore   Decimal       @db.Decimal(15, 2)
  balanceAfter    Decimal       @db.Decimal(15, 2)
  // Reference
  referenceType   String?       @db.VarChar(50) // "topup", "campaign_spend", "refund"
  referenceId     String?       @db.Uuid
  campaignId      String?       @db.Uuid
  description     String?       @db.VarChar(500)
  // Idempotency
  idempotencyKey  String?       @unique @db.VarChar(100)
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)

  balance SellerAdBalance @relation(fields: [balanceId], references: [id])

  @@index([balanceId])
  @@index([sellerId])
  @@index([createdAt])
  @@map("ad_balance_transaction")
}

// =============================================================================
// AD CAMPAIGNS
// =============================================================================

model AdCampaign {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId          String           @db.Uuid // Reference to Seller Service
  campaignName      String           @db.VarChar(255)
  campaignType      AdCampaignType
  // Budget
  dailyBudget       Decimal          @db.Decimal(15, 2)
  totalBudget       Decimal?         @db.Decimal(15, 2)
  spentToday        Decimal          @default(0) @db.Decimal(15, 2)
  spentTotal        Decimal          @default(0) @db.Decimal(15, 2)
  // Pricing
  pricingModel      AdPricingModel
  bidAmount         Decimal          @db.Decimal(10, 2)
  // Targeting
  targetCategories  String[]         @db.Uuid
  targetKeywords    String[]
  targetLocations   String[]         // Province/city codes
  targetGender      String?          @db.VarChar(20) // "all", "male", "female"
  targetAgeMin      Int?
  targetAgeMax      Int?
  // Schedule
  startDate         DateTime         @db.Timestamptz(6)
  endDate           DateTime?        @db.Timestamptz(6)
  scheduleDays      String[]         // ["monday", "tuesday", ...]
  scheduleStartHour Int?             // 0-23
  scheduleEndHour   Int?             // 0-23
  // Status
  status            AdCampaignStatus @default(draft)
  pausedAt          DateTime?        @db.Timestamptz(6)
  pauseReason       String?          @db.VarChar(255)
  // Performance (aggregated)
  totalImpressions  Int              @default(0)
  totalClicks       Int              @default(0)
  totalConversions  Int              @default(0)
  totalRevenue      Decimal          @default(0) @db.Decimal(15, 2)
  // Audit
  createdBy         String?          @db.Uuid
  createdAt         DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime         @updatedAt @db.Timestamptz(6)
  deletedAt         DateTime?        @db.Timestamptz(6)

  products    AdCampaignProduct[]
  impressions AdImpression[]
  clicks      AdClick[]
  conversions AdConversion[]
  dailyStats  AdCampaignDailyStat[]

  @@index([sellerId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@map("ad_campaign")
}

model AdCampaignProduct {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId  String   @db.Uuid
  productId   String   @db.Uuid // Reference to Seller's product
  // Custom settings per product
  customBid   Decimal? @db.Decimal(10, 2)
  customTitle String?  @db.VarChar(255)
  customImage String?
  // Status
  isActive    Boolean  @default(true)
  // Performance
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  spent       Decimal  @default(0) @db.Decimal(15, 2)
  revenue     Decimal  @default(0) @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, productId])
  @@index([productId])
  @@map("ad_campaign_product")
}

// =============================================================================
// AD IMPRESSIONS, CLICKS, CONVERSIONS
// =============================================================================

model AdImpression {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId  String   @db.Uuid
  productId   String?  @db.Uuid
  userId      String?  @db.Uuid
  // Placement info
  placement   String   @db.VarChar(50) // "search", "category", "homepage", "product_page"
  position    Int?     // Position in listing
  page        Int?     // Page number
  // Cost
  cost        Decimal  @default(0) @db.Decimal(10, 4)
  // Context
  searchQuery String?  @db.VarChar(255)
  categoryId  String?  @db.Uuid
  // Session tracking
  sessionId   String?  @db.VarChar(100)
  deviceType  String?  @db.VarChar(20) // "mobile", "desktop", "tablet"
  // Timestamp
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([productId])
  @@index([createdAt])
  @@map("ad_impression")
}

model AdClick {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId    String   @db.Uuid
  impressionId  String?  @db.Uuid
  productId     String?  @db.Uuid
  userId        String?  @db.Uuid
  // Cost
  cost          Decimal  @db.Decimal(10, 4)
  // Context
  placement     String?  @db.VarChar(50)
  searchQuery   String?  @db.VarChar(255)
  // Session
  sessionId     String?  @db.VarChar(100)
  deviceType    String?  @db.VarChar(20)
  ipAddress     String?  @db.VarChar(45)
  userAgent     String?
  // Fraud detection
  isSuspicious  Boolean  @default(false)
  fraudScore    Decimal? @db.Decimal(5, 2)
  // Timestamp
  createdAt     DateTime @default(now()) @db.Timestamptz(6)

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([impressionId])
  @@index([createdAt])
  @@map("ad_click")
}

model AdConversion {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId   String   @db.Uuid
  clickId      String?  @db.Uuid
  productId    String?  @db.Uuid
  userId       String?  @db.Uuid
  orderId      String   @db.Uuid // Reference to Order Service
  // Conversion value
  orderAmount  Decimal  @db.Decimal(15, 2)
  // Attribution
  attributionType String @default("last_click") @db.VarChar(50)
  attributionWindow Int  @default(7) // Days
  // Timestamps
  clickedAt    DateTime? @db.Timestamptz(6)
  convertedAt  DateTime @default(now()) @db.Timestamptz(6)

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([orderId])
  @@index([convertedAt])
  @@map("ad_conversion")
}

// =============================================================================
// AD CAMPAIGN DAILY STATS (Aggregated for reporting)
// =============================================================================

model AdCampaignDailyStat {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignId    String   @db.Uuid
  date          DateTime @db.Date
  // Metrics
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  conversions   Int      @default(0)
  spent         Decimal  @default(0) @db.Decimal(15, 2)
  revenue       Decimal  @default(0) @db.Decimal(15, 2)
  // Calculated metrics
  ctr           Decimal? @db.Decimal(8, 4) // Click-through rate
  cvr           Decimal? @db.Decimal(8, 4) // Conversion rate
  cpc           Decimal? @db.Decimal(10, 2) // Cost per click
  cpa           Decimal? @db.Decimal(10, 2) // Cost per acquisition
  roas          Decimal? @db.Decimal(8, 2) // Return on ad spend
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, date])
  @@index([date])
  @@map("ad_campaign_daily_stat")
}

// =============================================================================
// BANNER ADS
// =============================================================================

model BannerAdSlot {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slotCode       String   @unique @db.VarChar(50) // "homepage_hero", "category_sidebar"
  slotName       String   @db.VarChar(100)
  slotLocation   String   @db.VarChar(100) // Page/section
  description    String?
  // Dimensions
  width          Int
  height         Int
  // Pricing
  pricePerDay    Decimal  @db.Decimal(15, 2)
  pricePerWeek   Decimal? @db.Decimal(15, 2)
  pricePerMonth  Decimal? @db.Decimal(15, 2)
  // Settings
  maxFileSize    Int?     // KB
  allowedFormats String[] // ["jpg", "png", "gif"]
  isActive       Boolean  @default(true)
  displayOrder   Int      @default(0)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  bookings BannerAdBooking[]

  @@map("banner_ad_slot")
}

model BannerAdBooking {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slotId         String        @db.Uuid
  sellerId       String        @db.Uuid // Reference to Seller Service
  // Creative
  imageUrl       String        @db.VarChar(500)
  mobileImageUrl String?       @db.VarChar(500)
  clickUrl       String        @db.VarChar(500)
  altText        String?       @db.VarChar(255)
  // Schedule
  startDate      DateTime      @db.Date
  endDate        DateTime      @db.Date
  // Pricing
  pricePerDay    Decimal       @db.Decimal(15, 2)
  totalDays      Int
  totalPrice     Decimal       @db.Decimal(15, 2)
  // Payment
  paymentStatus  PaymentStatus @default(pending)
  paidAt         DateTime?     @db.Timestamptz(6)
  // Approval
  status         BannerStatus  @default(pending)
  approvedBy     String?       @db.Uuid
  approvedAt     DateTime?     @db.Timestamptz(6)
  rejectedBy     String?       @db.Uuid
  rejectedAt     DateTime?     @db.Timestamptz(6)
  rejectionReason String?      @db.VarChar(500)
  // Performance
  impressions    Int           @default(0)
  clicks         Int           @default(0)
  // Audit
  createdAt      DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime      @updatedAt @db.Timestamptz(6)

  slot BannerAdSlot @relation(fields: [slotId], references: [id])

  @@index([slotId])
  @@index([sellerId])
  @@index([startDate, endDate])
  @@index([status])
  @@map("banner_ad_booking")
}

// =============================================================================
// SPONSORED POSTS (Social Commerce - promote posts in feed)
// =============================================================================

model SponsoredPost {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String              @db.Uuid // User or Seller promoting the post
  postId            String              @db.Uuid // Reference to Content Service post
  // Budget
  dailyBudget       Decimal             @db.Decimal(15, 2)
  totalBudget       Decimal?            @db.Decimal(15, 2)
  spentToday        Decimal             @default(0) @db.Decimal(15, 2)
  spentTotal        Decimal             @default(0) @db.Decimal(15, 2)
  // Pricing (CPM - Cost Per Mille/1000 impressions)
  cpmRate           Decimal             @db.Decimal(10, 2) // e.g., Rp 10,000 per 1000 views
  // Targeting
  targetLocations   String[]            // Province/city codes
  targetGender      String?             @db.VarChar(20) // "all", "female", "male"
  targetAgeMin      Int?
  targetAgeMax      Int?
  targetInterests   String[]            // Interest tags
  // Schedule
  startDate         DateTime            @db.Timestamptz(6)
  endDate           DateTime?           @db.Timestamptz(6)
  // Status
  status            SponsoredPostStatus @default(draft)
  approvedAt        DateTime?           @db.Timestamptz(6)
  approvedBy        String?             @db.Uuid
  rejectedAt        DateTime?           @db.Timestamptz(6)
  rejectionReason   String?             @db.VarChar(500)
  // Performance
  totalImpressions  Int                 @default(0)
  totalClicks       Int                 @default(0)
  totalSaves        Int                 @default(0)
  totalProfileVisits Int                @default(0)
  // Audit
  createdAt         DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime            @updatedAt @db.Timestamptz(6)

  dailyStats SponsoredPostDailyStat[]

  @@index([userId])
  @@index([postId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("sponsored_post")
}

model SponsoredPostDailyStat {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sponsoredPostId String   @db.Uuid
  date            DateTime @db.Date
  // Metrics
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  saves           Int      @default(0)
  profileVisits   Int      @default(0)
  spent           Decimal  @default(0) @db.Decimal(15, 2)
  // Calculated
  ctr             Decimal? @db.Decimal(8, 4) // Click-through rate
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  sponsoredPost SponsoredPost @relation(fields: [sponsoredPostId], references: [id], onDelete: Cascade)

  @@unique([sponsoredPostId, date])
  @@index([date])
  @@map("sponsored_post_daily_stat")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100)
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum BalanceStatus {
  active
  frozen
  suspended
}

enum AdBalanceTxType {
  topup
  spend
  refund
  adjustment
}

enum AdCampaignType {
  product_boost    // Boost product in search/listings
  search_ads       // Search result ads
  banner           // Display banner ads
  homepage_feature // Homepage featured products
  category_feature // Category page featured
  sponsored_post   // Sponsored content post (social commerce)
}

enum AdPricingModel {
  cpc   // Cost per click
  cpm   // Cost per 1000 impressions
  cpa   // Cost per acquisition
  fixed // Fixed daily rate
}

enum AdCampaignStatus {
  draft
  pending_review
  active
  paused
  completed
  exhausted      // Budget depleted
  rejected
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum BannerStatus {
  pending
  approved
  rejected
  active
  completed
  cancelled
}

enum SponsoredPostStatus {
  draft
  pending_review
  approved
  active
  paused
  completed
  exhausted       // Budget depleted
  rejected
}
