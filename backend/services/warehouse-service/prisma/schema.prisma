// =============================================================================
// WAREHOUSE SERVICE DATABASE SCHEMA
// Service: warehouse-service (Port 3012)
// Database: warehouse_db
// Owner: Inventory management, grosir bundles, purchase orders, stock reservations
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// WAREHOUSE INVENTORY
// =============================================================================

model WarehouseInventory {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId         String          @map("product_id") @db.Uuid // Reference to Product Service
  variantId         String?         @map("variant_id") @db.Uuid // Reference to Product Service
  // SKU tracking
  sku               String          @db.VarChar(100)
  // Quantities
  quantity          Int             @default(0) // Total physical stock
  reservedQuantity  Int             @default(0) @map("reserved_quantity") // Reserved for pending orders
  availableQuantity Int             @default(0) @map("available_quantity") // quantity - reservedQuantity (computed)
  damagedQuantity   Int             @default(0) @map("damaged_quantity") // Damaged/unsellable
  // Stock levels
  minStockLevel     Int             @default(0) @map("min_stock_level") // Alert threshold
  maxStockLevel     Int?            @map("max_stock_level") // Maximum storage capacity
  reorderPoint      Int?            @map("reorder_point") // When to reorder
  reorderQuantity   Int?            @map("reorder_quantity") // How much to reorder
  // Location in warehouse
  location          String?         @db.VarChar(100) // Aisle-Shelf-Bin
  zone              String?         @db.VarChar(50)
  // Tracking
  lastRestockedAt   DateTime?       @map("last_restocked_at") @db.Timestamptz(6)
  lastSoldAt        DateTime?       @map("last_sold_at") @db.Timestamptz(6)
  lastCountedAt     DateTime?       @map("last_counted_at") @db.Timestamptz(6)
  // Status
  status            InventoryStatus @default(active)
  // Optimistic locking
  version           Int             @default(0)
  // Audit
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)

  movements    InventoryMovement[]
  reservations StockReservation[]

  @@unique([productId, variantId])
  @@index([productId])
  @@index([sku])
  @@index([availableQuantity])
  @@index([status])
  @@map("warehouse_inventory")
}

// =============================================================================
// INVENTORY MOVEMENTS (Audit trail)
// =============================================================================

model InventoryMovement {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId     String       @map("inventory_id") @db.Uuid
  movementNumber  String       @unique @map("movement_number") @db.VarChar(50) // MOV-20260115-XXXXX
  type            MovementType
  // Quantities
  quantityBefore  Int          @map("quantity_before")
  quantityChange  Int          @map("quantity_change") // Positive for in, negative for out
  quantityAfter   Int          @map("quantity_after")
  // Reference
  referenceType   String?      @map("reference_type") @db.VarChar(50) // "order", "po", "adjustment", etc.
  referenceId     String?      @map("reference_id") @db.Uuid
  orderId         String?      @map("order_id") @db.Uuid
  purchaseOrderId String?      @map("purchase_order_id") @db.Uuid
  // Details
  reason          String?      @db.VarChar(500)
  notes           String?
  // Cost tracking
  unitCost        Decimal?     @map("unit_cost") @db.Decimal(15, 2)
  totalCost       Decimal?     @map("total_cost") @db.Decimal(15, 2)
  // Audit
  createdBy       String?      @map("created_by") @db.Uuid
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  inventory WarehouseInventory @relation(fields: [inventoryId], references: [id])

  @@index([inventoryId])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("inventory_movement")
}

// =============================================================================
// STOCK RESERVATIONS (For pending orders)
// =============================================================================

model StockReservation {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String            @map("inventory_id") @db.Uuid
  orderId     String            @map("order_id") @db.Uuid // Reference to Order Service
  orderItemId String?           @map("order_item_id") @db.Uuid
  quantity    Int
  status      ReservationStatus @default(reserved)
  reservedAt  DateTime          @default(now()) @map("reserved_at") @db.Timestamptz(6)
  confirmedAt DateTime?         @map("confirmed_at") @db.Timestamptz(6) // When order shipped
  releasedAt  DateTime?         @map("released_at") @db.Timestamptz(6) // When reservation cancelled
  expiresAt   DateTime          @map("expires_at") @db.Timestamptz(6) // Auto-release if not confirmed
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  inventory WarehouseInventory @relation(fields: [inventoryId], references: [id])

  @@index([inventoryId])
  @@index([orderId])
  @@index([status])
  @@index([expiresAt])
  @@map("stock_reservation")
}

// =============================================================================
// GROSIR BUNDLE CONFIGURATION
// This is the key differentiator - factories ship in fixed bundles
// =============================================================================

model GrosirBundleConfig {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId      String   @map("product_id") @db.Uuid // Reference to Product Service
  supplierId     String?  @map("supplier_id") @db.Uuid // Reference to Supplier Service
  // Bundle composition
  bundleName     String?  @map("bundle_name") @db.VarChar(255)
  totalUnits     Int      @map("total_units") // Total units per bundle (e.g., 12)
  // Size breakdown (JSON for flexibility)
  // e.g., {"S": 2, "M": 5, "L": 4, "XL": 1}
  sizeBreakdown  Json     @map("size_breakdown")
  // Pricing
  bundleCost     Decimal  @map("bundle_cost") @db.Decimal(15, 2)
  costPerUnit    Decimal  @map("cost_per_unit") @db.Decimal(15, 2)
  // Constraints
  minBundleOrder Int      @default(1) @map("min_bundle_order")
  // Status
  isActive       Boolean  @default(true) @map("is_active")
  notes          String?
  // Audit
  createdBy      String?  @map("created_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([productId, supplierId])
  @@index([productId])
  @@map("grosir_bundle_config")
}

// =============================================================================
// GROSIR WAREHOUSE TOLERANCE
// Maximum excess inventory allowed per variant before locking
// =============================================================================

model GrosirWarehouseTolerance {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId             String    @map("product_id") @db.Uuid
  variantId             String?   @map("variant_id") @db.Uuid
  size                  String?   @db.VarChar(50)
  // Tolerance settings
  maxExcessUnits        Int       @map("max_excess_units") // Max units above normal stock
  currentExcess         Int       @default(0) @map("current_excess") // Current excess level
  // Variant locking
  isLocked              Boolean   @default(false) @map("is_locked")
  lockedAt              DateTime? @map("locked_at") @db.Timestamptz(6)
  lockedReason          String?   @map("locked_reason") @db.VarChar(255)
  // Clearance tracking
  clearanceRateEstimate Int?      @map("clearance_rate_estimate") // Estimated units sold per day
  expectedClearanceDays Int?      @map("expected_clearance_days") // Days to clear excess
  // Status
  isActive              Boolean   @default(true) @map("is_active")
  notes                 String?
  // Audit
  updatedBy             String?   @map("updated_by") @db.Uuid
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([productId, variantId])
  @@index([productId])
  @@index([isLocked])
  @@map("grosir_warehouse_tolerance")
}

// =============================================================================
// PURCHASE ORDERS (To suppliers)
// =============================================================================

model WarehousePurchaseOrder {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  poNumber        String    @unique @map("po_number") @db.VarChar(50) // PO-20260115-XXXXX
  supplierId      String    @map("supplier_id") @db.Uuid // Reference to Supplier Service
  // Supplier snapshot
  supplierName    String    @map("supplier_name") @db.VarChar(255)
  supplierContact String?   @map("supplier_contact") @db.VarChar(255)
  supplierPhone   String?   @map("supplier_phone") @db.VarChar(20)
  // Totals
  totalItems      Int       @map("total_items")
  totalUnits      Int       @map("total_units")
  subtotal        Decimal   @db.Decimal(15, 2)
  shippingCost    Decimal   @default(0) @map("shipping_cost") @db.Decimal(15, 2)
  taxAmount       Decimal   @default(0) @map("tax_amount") @db.Decimal(15, 2)
  totalCost       Decimal   @map("total_cost") @db.Decimal(15, 2)
  currency        String    @default("IDR") @db.VarChar(3)
  // Dates
  orderDate       DateTime  @default(now()) @map("order_date") @db.Timestamptz(6)
  expectedDate    DateTime? @map("expected_date") @db.Timestamptz(6)
  shippedDate     DateTime? @map("shipped_date") @db.Timestamptz(6)
  receivedDate    DateTime? @map("received_date") @db.Timestamptz(6)
  // Status
  status          PoStatus  @default(draft)
  // Payment
  paymentTerms    String?   @map("payment_terms") @db.VarChar(100)
  paymentStatus   String?   @map("payment_status") @db.VarChar(50)
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  // Notes
  notes           String?
  internalNotes   String?   @map("internal_notes")
  // Audit
  createdBy       String?   @map("created_by") @db.Uuid
  approvedBy      String?   @map("approved_by") @db.Uuid
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  items PurchaseOrderItem[]

  @@index([poNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("warehouse_purchase_order")
}

model PurchaseOrderItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  purchaseOrderId String   @map("purchase_order_id") @db.Uuid
  productId       String   @map("product_id") @db.Uuid
  variantId       String?  @map("variant_id") @db.Uuid
  // Product snapshot
  productName     String   @map("product_name") @db.VarChar(255)
  variantName     String?  @map("variant_name") @db.VarChar(255)
  sku             String   @db.VarChar(100)
  // Quantities
  bundleQuantity  Int      @map("bundle_quantity") // Number of grosir bundles
  unitsPerBundle  Int      @map("units_per_bundle")
  totalUnits      Int      @map("total_units") // bundleQuantity * unitsPerBundle
  // Pricing
  unitCost        Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost       Decimal  @map("total_cost") @db.Decimal(15, 2)
  // Receiving
  receivedUnits   Int      @default(0) @map("received_units")
  damagedUnits    Int      @default(0) @map("damaged_units")
  // Status
  status          String   @default("pending") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  purchaseOrder WarehousePurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_item")
}

// =============================================================================
// STOCK ALERTS
// =============================================================================

model StockAlert {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId    String         @map("inventory_id") @db.Uuid
  productId      String         @map("product_id") @db.Uuid
  variantId      String?        @map("variant_id") @db.Uuid
  alertType      StockAlertType @map("alert_type")
  // Details
  currentStock   Int            @map("current_stock")
  threshold      Int
  message        String         @db.VarChar(500)
  // Status
  status         AlertStatus    @default(active)
  acknowledgedAt DateTime?      @map("acknowledged_at") @db.Timestamptz(6)
  acknowledgedBy String?        @map("acknowledged_by") @db.Uuid
  resolvedAt     DateTime?      @map("resolved_at") @db.Timestamptz(6)
  // Timestamps
  triggeredAt    DateTime       @default(now()) @map("triggered_at") @db.Timestamptz(6)

  @@index([inventoryId])
  @@index([alertType])
  @@index([status])
  @@map("stock_alert")
}

// =============================================================================
// SERVICE OUTBOX (For Kafka event publishing)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(100)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum InventoryStatus {
  active
  inactive
  discontinued
}

enum MovementType {
  purchase_order_received // Stock in from supplier
  order_fulfilled         // Stock out for order
  order_cancelled         // Stock returned from cancelled order
  return_received         // Stock in from customer return
  adjustment_in           // Manual increase
  adjustment_out          // Manual decrease
  damage                  // Damaged stock
  transfer_in             // Transfer from another location
  transfer_out            // Transfer to another location
  initial_stock           // Initial inventory setup
}

enum ReservationStatus {
  reserved      // Stock held for order
  confirmed     // Order shipped, reservation permanent
  released      // Order cancelled, stock released
  expired       // Reservation timed out
}

enum PoStatus {
  draft
  pending_approval
  approved
  sent_to_supplier
  partially_received
  received
  cancelled
}

enum StockAlertType {
  low_stock          // Below minimum level
  out_of_stock       // Zero available
  excess_stock       // Above maximum level
  grosir_locked      // Variant locked due to grosir constraints
  slow_moving        // Not selling well
  expiring_soon      // For perishable items
}

enum AlertStatus {
  active
  acknowledged
  resolved
  dismissed
}
