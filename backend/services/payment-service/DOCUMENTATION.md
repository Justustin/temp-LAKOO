# Payment Service Documentation (`backend/services/payment-service`)

This document explains **each file** in the payment-service, and (for source files) explains **each function / method** and how it relates to **routes → controllers → services → repositories → database**. It also includes a **thorough middleware** section.

> Notes:
> - `node_modules/` is third‑party and not documented here.
> - `src/generated/prisma/` is **Prisma generated output**; it’s documented as autogenerated (not handwritten business logic).

## High-level overview

### What this service does
- **Creates payments** by creating a **Xendit invoice** and persisting a `Payment` record.
- **Processes webhooks** from Xendit to mark payments as **PAID** or **EXPIRED** (with idempotency).
- **Creates refunds** and supports an admin flow to approve/reject; a service function can also process refunds (e-wallet via Xendit; bank refunds are “manual”).
- **Exposes transaction history/summary** by aggregating `Payment`, `Refund`, and `PaymentGatewayLog` records.
- **Runs background jobs** for expiration, reconciliation, and weekly settlement summarization/outbox publishing.

### Layering (how code is organized)
- **Routes** (`src/routes/*.routes.ts`): Express endpoints and request validation (currently `express-validator`).
- **Controllers** (`src/controllers/*.controller.ts`): HTTP handlers that call services or Prisma directly.
- **Services** (`src/services/*.service.ts`): Business logic; calls repositories and external services (Auth/Order/Notification/Xendit).
- **Repositories** (`src/repositories/*.repository.ts`): Database access via Prisma for a specific aggregate.
- **Database** (`prisma/schema.prisma`): Prisma schema for `Payment`, `Refund`, `PaymentGatewayLog`, etc.
- **Middleware** (`src/middleware/*.ts`): Gateway-trust auth, `express-validator` result handling, error wrapper/handler.

### Request flow (typical)
1. **Route** validates request (today: `express-validator` in route file).
2. **Controller** calls a **Service** method.
3. **Service**:
   - Calls other services (Auth, Order, Notification),
   - Calls **Xendit** SDK / API (invoice create; refund API),
   - Calls a **Repository** (Prisma writes/reads).
4. Response returned; async errors bubble to the centralized `errorHandler` middleware.

## Environment variables (what the code expects)

Common variables referenced across files:
- **`PORT`**: Express listen port (`src/index.ts` defaults to `3006`; Docker exposes `3007`).
- **`DATABASE_URL`**: Postgres connection string (Prisma).
- **`XENDIT_SECRET_KEY`**: Xendit secret key (invoice create; refund API auth).
- **`XENDIT_WEBHOOK_VERIFICATION_TOKEN`**: Webhook callback token used by `CryptoUtils.verifyXenditWebhook` (matches Xendit `x-callback-token` header).
- **`AUTH_SERVICE_URL`**: Auth service base URL (validate token; fetch user).
- **`ORDER_SERVICE_URL`**: Order service base URL (fetch order; update order status).
- **`NOTIFICATION_SERVICE_URL`**: Notification service base URL (send notifications).
- **`GATEWAY_SECRET_KEY`**: shared secret used by `gatewayAuth` to verify requests came from the API Gateway (`x-gateway-key` header).
- **`INTERNAL_API_KEY`**: API key for internal service-to-service calls (`x-internal-api-key` header).
- **`ALLOWED_ORIGINS`**: CORS allowlist (currently commented out in `src/index.ts`).
- **`PAYMENT_SUCCESS_URL` / `PAYMENT_FAILURE_URL`**: Redirect URLs on Xendit invoice.
- **`PLACEHOLDER_EMAIL_DOMAIN`**: Domain for generated placeholder emails.
- **`ENABLE_EXPIRATION_CRON`** / **`EXPIRATION_CRON_SCHEDULE`**: Toggle/schedule for expiration cron in `src/index.ts`.

## Endpoint → Controller → Service/Repo map

### Payments & refunds (`/api/payments/*`) — `src/routes/payment.routes.ts`
- Route-level auth: `router.use(gatewayOrInternalAuth)` (gateway users or internal service calls)
- Validation: `express-validator` + `validateRequest`
- **POST `/api/payments/`**
  - Route validation: `express-validator` rules on `orderId`, `userId`, `amount`, `idempotencyKey`, `paymentMethod`
  - Controller: `PaymentController.createPayment`
  - Service: `PaymentService.createPayment`
  - Repo: `PaymentRepository.findByIdempotencyKey` (idempotent reuse), `PaymentRepository.create`
  - External deps: `PaymentService.fetchUser` (auth-service), Xendit `createInvoice`

- **GET `/api/payments/:id`**
  - Controller: `PaymentController.getPaymentById`
  - Service: `PaymentService.getPaymentById`
  - Repo: `PaymentRepository.findById`

- **GET `/api/payments/order/:orderId`**
  - Controller: `PaymentController.getPaymentByOrder`
  - Service: `PaymentService.getPaymentByOrderId`
  - Repo: `PaymentRepository.findByOrderId`

- **GET `/api/payments/user/:userId`**
  - Controller: `PaymentController.getPaymentsByUser`
  - Service: `PaymentService.getPaymentsByUserId`
  - Repo: `PaymentRepository.findByUserId`

- **POST `/api/payments/eligible-for-settlement`**
  - Controller: `PaymentController.getEligibleForSettlement`
  - Service: `PaymentService.findEligibleForSettlement`
  - Repo: `PaymentRepository.findEligibleForSettlement`

- **POST `/api/payments/stats`**
  - Controller: `PaymentController.getPaymentStats`
  - Service: `PaymentService.getPaymentStats`
  - Repo: `PaymentRepository.getPaymentStats`

- **POST `/api/payments/refunds`**
  - Controller: `PaymentController.createRefund`
  - Service: `RefundService.createRefund`
  - Repos: `PaymentRepository.findById`, `RefundRepository.create`

- **GET `/api/payments/refunds/:id`**
  - Controller: `PaymentController.getRefundById`
  - Service: `RefundService.getRefundById`
  - Repo: `RefundRepository.findById`

- **GET `/api/payments/refunds/order/:orderId`**
  - Controller: `PaymentController.getRefundsByOrder`
  - Service: `RefundService.getRefundsByOrderId`
  - Repo: `RefundRepository.findByOrderId`

### Webhooks (`/api/webhooks/*`) — `src/routes/webhook.routes.ts`
- **POST `/api/webhooks/xendit/invoice`**
  - Controller: `WebhookController.handleXenditCallback`
  - Signature verification: `CryptoUtils.verifyXenditWebhook`
  - Idempotency: checks `PaymentGatewayLog` for previously processed event
  - Success path:
    - if `PAID`: `PaymentService.handlePaidCallback` → `PaymentRepository.markPaid` → `PaymentService.updateOrderStatus` → `NotificationClient.sendNotification`
    - if `EXPIRED`: direct Prisma update to `Payment` + outbox event `payment.expired`

- **GET `/api/webhooks/health`**
  - Inline handler responding healthy.

### Transactions (`/api/transactions/*`) — `src/routes/transaction.routes.ts`
Route-level auth: `router.use(gatewayOrInternalAuth)` + `validateRequest`
- **GET `/api/transactions/order/:orderId`** → `TransactionController.getOrderTransactionHistory` → `TransactionLedgerService.getOrderTransactionHistory`
- **GET `/api/transactions/payment/:paymentId`** → `TransactionController.getPaymentTransactionHistory` → `TransactionLedgerService.getPaymentTransactionHistory`
- **GET `/api/transactions/factory/:factoryId/summary`** → `TransactionController.getFactoryTransactionSummary` → `TransactionLedgerService.getFactoryTransactionSummary`
- **GET `/api/transactions/summary`** → `TransactionController.getTransactionSummary` → `TransactionLedgerService.getTransactionSummary`
- **GET `/api/transactions/recent`** → `TransactionController.getRecentTransactions` → `TransactionLedgerService.getRecentTransactions`
- **GET `/api/transactions/:transactionCode`** → `TransactionController.findByCode` → `TransactionLedgerService.findByCode`

### Admin (`/api/admin/*`) — `src/routes/admin.routes.ts`
Admin endpoints currently call Prisma **directly** via `AdminController` (not via services/repositories).
Route-level auth: `router.use(gatewayAuth)` + `router.use(requireRole('admin'))` + `validateRequest`
- **GET `/api/admin/payments`** → `AdminController.getAllPayments` → Prisma `payment.count`, `payment.findMany`
- **GET `/api/admin/payments/:id`** → `AdminController.getPaymentDetails` → Prisma `payment.findUnique`
- **GET `/api/admin/refunds`** → `AdminController.getAllRefunds` → Prisma `refund.count`, `refund.findMany`
- **POST `/api/admin/refunds/:id/process`** → `AdminController.processRefund` → Prisma `refund.update`, `payment.update`
- **GET `/api/admin/analytics`** → `AdminController.getPaymentAnalytics` → Prisma aggregates/groupBy
- **GET `/api/admin/settlements`** → `AdminController.getSettlementRecords` → Prisma `settlementRecord.findMany`
- **GET `/api/admin/gateway-logs`** → `AdminController.getGatewayLogs` → Prisma `paymentGatewayLog.findMany`

## Middleware (thorough)

> Middleware files live under `src/middleware/`. In the current code, **auth and validation are applied at the router level** (see `src/routes/*.routes.ts`), and `errorHandler` is mounted in `src/index.ts`.

### `src/middleware/error-handler.ts`
Defines a consistent error model and helpers.

- **`class AppError extends Error`**
  - Purpose: base “operational” error with HTTP status code and optional `code`.
  - Fields:
    - `statusCode`: HTTP status to send
    - `isOperational`: marks expected errors vs unknown failures
    - `code`: optional machine-readable error code

- **`class BadRequestError / UnauthorizedError / ForbiddenError / NotFoundError / ConflictError / PaymentError`**
  - Purpose: typed errors for common categories.
  - Each sets a default status code (400/401/403/404/409/402).

- **`errorHandler(err, req, res, _next)`**
  - Purpose: Express error middleware to format errors.
  - Behavior:
    - Logs method/path + message (+ stack in development).
    - If `err instanceof AppError`: responds with `statusCode`, `err.message`, and optional `err.code`.
    - If Prisma known error (by `err.name === 'PrismaClientKnownRequestError'`):
      - `P2002` → 409 duplicate entry
      - `P2025` → 404 not found
      - default → 400 database operation failed
    - If validation error (`ValidationError` / `ZodError`) → 400 with details (Zod support is legacy; runtime validation uses `express-validator` + `validateRequest`)
    - Otherwise → 500 “Internal server error” (production) or `err.message` (non-prod)

- **`asyncHandler(fn)`**
  - Purpose: wrapper to avoid `try/catch` in every async Express handler.
  - Behavior: returns a function that calls `fn(req,res,next)` and forwards rejected promises to `next`.
  - Typical usage:
    - `router.get('/x', asyncHandler(async (req,res) => { ... }))`

### `src/middleware/auth.ts`
Implements authentication/authorization for HTTP endpoints.

#### Types
- **`interface AuthenticatedRequest extends Request`**
  - Adds optional `user` field:
    - `id`, optional `role`

#### Middleware functions
- **`gatewayAuth(req, res, next)`**
  - Purpose: **trust authentication at the API Gateway**, but verify the request really came from the gateway using a shared secret.
  - Required headers:
    - `x-gateway-key`: must match `process.env.GATEWAY_SECRET_KEY`
    - `x-user-id`: required (the authenticated user id)
    - `x-user-role`: optional
  - Behavior:
    - If `GATEWAY_SECRET_KEY` is missing: rejects (except a dev fallback described below).
    - If `x-gateway-key` mismatch: rejects.
    - Otherwise sets `req.user = { id, role }` and continues.
  - Dev-mode note:
    - If `NODE_ENV=development` **and** no `GATEWAY_SECRET_KEY` is configured, it falls back to a default user (`dev-user`) or forwarded headers.

- **`requireRole(...roles)`**
  - Purpose: authorization based on `req.user.role`.
  - Behavior:
    - If no `req.user` → `UnauthorizedError('Not authenticated')`
    - If role not in allowed list → `ForbiddenError('Insufficient permissions')`

- **`optionalGatewayAuth(req, res, next)`**
  - Purpose: best-effort gateway auth that does not fail the request.
  - Behavior: if `x-gateway-key` matches `GATEWAY_SECRET_KEY`, it sets `req.user`; otherwise continues without a user.

- **`internalServiceAuth(req, res, next)`**
  - Purpose: authenticate **service-to-service** calls using an internal API key.
  - Header:
    - `x-internal-api-key`: must match `process.env.INTERNAL_API_KEY`

- **`gatewayOrInternalAuth(req, res, next)`**
  - Purpose: accept **either** gateway-authenticated user traffic **or** internal service traffic.
  - Behavior:
    - If `x-internal-api-key` matches `INTERNAL_API_KEY`, sets `req.user` to a service identity (or forwarded `x-user-id`) and continues.
    - Else if `x-gateway-key` matches `GATEWAY_SECRET_KEY`, requires `x-user-id` and sets `req.user`.
    - Else if `NODE_ENV=development`, falls back to a default dev user.
    - Otherwise rejects with `UnauthorizedError('Authentication required')`.

### `src/middleware/validation.ts`
Provides runtime validation handling for `express-validator`, plus shared TypeScript input types.

- **`validateRequest(req, res, next)`**
  - Purpose: return a consistent 400 response if any `express-validator` checks failed.
  - Usage: added after the validator arrays in route definitions.
  - Response shape (on failure): `{ success:false, error:'Validation failed', details:[{ field, message }] }`

- **TypeScript types**
  - The remainder of the file exports shared TS types (e.g. `PaymentMethod`, `CreatePaymentInput`) for compile-time use.

### `src/middleware/index.ts`
Barrel re-export:
- `export * from './error-handler'`
- `export * from './auth'`
- `export * from './validation'`

## File-by-file documentation

### Root files

#### `package.json`
Defines service metadata, scripts, and dependencies.
- **Scripts**
  - `dev`: run via `tsx watch src/index.ts`
  - `build`: compile to `dist/` using TypeScript
  - `start`: run `dist/index.js`
  - `db:*`: Prisma generate/migrate/push/studio
  - `cron:*`: run jobs directly (`weekly-settlement`, `expire-payments`)
  - `test`: Jest test runner

#### `pnpm-lock.yaml`
Lock file for reproducible dependency installs (not executed by runtime directly).

#### `tsconfig.json`
TypeScript configuration:
- NodeNext module resolution, strict typechecking, output to `dist/`.
- Defines path aliases like `@/services/*` → `src/services/*`.

#### `jest.config.js`
Jest configuration for TypeScript tests (`ts-jest`), coverage thresholds, and patterns.

#### `Dockerfile`
Multi-stage Docker build:
- **Builder stage**: installs deps, runs `prisma generate`, builds TS.
- **Production stage**: installs production deps, copies Prisma engines/client + compiled `dist`.
- Uses `dumb-init` and exposes `3007`.

#### `docker-compose.yml`
Development stack:
- `payment-service` + `payment-db` (Postgres) + `redis` and a one-off `payment-migrate`.
- Sets many environment variables for service discovery.

#### `prisma/schema.prisma`
Database models and enums. Key models:
- **`Payment`**: core payment record (amounts, gateway IDs, status transitions, expiry).
- **`PaymentGatewayLog`**: audit trail for gateway calls and webhooks (also used for webhook idempotency).
- **`Refund`**: refund lifecycle (pending → approved → processing → completed/failed/rejected).
- **`SavedPaymentMethod`**: tokenized/saved methods (not used elsewhere in current code).
- **`SettlementRecord`**: daily/weekly settlement summaries and reconciliation status.
- **`ServiceOutbox`**: outbox table for publishing events to Kafka/other infra.
- **Enums**: `PaymentMethod`, `PaymentStatus`, `RefundMethod`, `RefundStatus`.

---

### `src/index.ts` (service entrypoint)
Sets up Express, swagger, routes, basic logging, error handling, and a cron scheduler.

- **`dotenv.config()`**
  - Loads `.env` into `process.env`.

- **Express middleware setup**
  - `express.json()` / `express.urlencoded()`: parse bodies.
  - Inline request logging middleware: measures duration and logs `METHOD path - status - ms`.

- **Routes mounted**
  - `/api-docs` → Swagger UI
  - `/api/payments` → `paymentRoutes`
  - `/api/webhooks` → `webhookRoutes`
  - `/api/transactions` → `transactionRoutes`
  - `/api/admin` → `adminRoutes`

- **`GET /`**
  - Redirects to `/api-docs`.

- **`GET /health`**
  - Returns service health JSON.

- **404 handler**
  - Returns `{ success:false, error:'Endpoint not found', path }`.

- **Global error handler**
  - Uses the centralized `errorHandler` from `src/middleware/error-handler.ts`.

- **`gracefulShutdown()`**
  - Closes HTTP server and forces exit after 10s.

- **Expiration cron**
  - Creates `new PaymentRepository()` and calls `expirePendingPayments()` on schedule.
  - Controlled by `ENABLE_EXPIRATION_CRON` and `EXPIRATION_CRON_SCHEDULE`.

---

### `src/lib/prisma.ts` and `src/lib/index.ts`
Prisma client singleton setup.

#### `src/lib/prisma.ts`
- **Global singleton logic**
  - Uses `globalThis.prisma` in non-production to avoid creating many clients in watch mode.

- **`prismaClientSingleton()`**
  - Creates `new PrismaClient` with log level based on `NODE_ENV`.

- **`export const prisma`**
  - The shared Prisma client instance used across repositories/services/controllers.

- **`process.on('beforeExit', ...)`**
  - Disconnects Prisma on process exit.

#### `src/lib/index.ts`
- Re-exports `prisma` from `./prisma`.

---

### `src/config/xendit.ts`
Xendit SDK setup.
- **`xenditSecretKey`**: read from `XENDIT_SECRET_KEY` (warns if missing).
- **`xenditClient`**: `new Xendit({ secretKey })`.
- **`xenditInvoiceClient`**: alias to `xenditClient.Invoice` used by `PaymentService.createPayment`.

---

### `src/config/swagger.ts`
Swagger OpenAPI generation via `swagger-jsdoc`.
- **`options`**
  - Defines OpenAPI metadata, servers, tags, shared schemas, and example paths.
  - Sets `apis: ['./src/routes/*.ts']` so JSDoc in route files gets picked up.
- **`swaggerSpec`**
  - `swaggerJsdoc(options)` exported for Swagger UI in `src/index.ts`.

---

### `src/types/index.ts`
Shared DTO interfaces for controllers/services/repositories.
- **`CreatePaymentDTO`**: input for creating payments (`orderId`, `userId`, `amount`, optional `paymentMethod`, `expiresAt`, required `idempotencyKey`, optional `metadata`).
- **`XenditInvoiceCallback`**: expected webhook payload shape (not enforced by routes currently).
- **`CreateRefundDTO`**: input for creating refunds.
- **`PaymentResponse`**: shape returned by create payment flow (`payment`, optional `paymentUrl`, `invoiceId`).

---

### Routes (`src/routes/*.routes.ts`)

#### `src/routes/payment.routes.ts`
Defines payment/refund endpoints and validates with `express-validator`.
- **POST `/`** → `PaymentController.createPayment`
- **GET `/:id`** → `PaymentController.getPaymentById`
- **GET `/order/:orderId`** → `PaymentController.getPaymentByOrder`
- **GET `/user/:userId`** → `PaymentController.getPaymentsByUser`
- **POST `/eligible-for-settlement`** → `PaymentController.getEligibleForSettlement`
- **POST `/stats`** → `PaymentController.getPaymentStats`
- **POST `/refunds`** → `PaymentController.createRefund`
- **GET `/refunds/:id`** → `PaymentController.getRefundById`
- **GET `/refunds/order/:orderId`** → `PaymentController.getRefundsByOrder`

#### `src/routes/webhook.routes.ts`
- **POST `/xendit/invoice`** → `WebhookController.handleXenditCallback`
- **GET `/health`** → inline health response

#### `src/routes/transaction.routes.ts`
Transaction ledger endpoints (mostly documented with Swagger annotations).
- **GET `/order/:orderId`** → `TransactionController.getOrderTransactionHistory`
- **GET `/payment/:paymentId`** → `TransactionController.getPaymentTransactionHistory`
- **GET `/factory/:factoryId/summary`** → `TransactionController.getFactoryTransactionSummary`
- **GET `/summary`** → `TransactionController.getTransactionSummary`
- **GET `/recent`** → `TransactionController.getRecentTransactions`
- **GET `/:transactionCode`** → `TransactionController.findByCode`

#### `src/routes/admin.routes.ts`
Admin endpoints, validated via `express-validator`.
- **GET `/payments`** → `AdminController.getAllPayments`
- **GET `/payments/:id`** → `AdminController.getPaymentDetails`
- **GET `/refunds`** → `AdminController.getAllRefunds`
- **POST `/refunds/:id/process`** → `AdminController.processRefund`
- **GET `/analytics`** → `AdminController.getPaymentAnalytics`
- **GET `/settlements`** → `AdminController.getSettlementRecords`
- **GET `/gateway-logs`** → `AdminController.getGatewayLogs`

---

### Controllers (`src/controllers/*.controller.ts`)

#### `src/controllers/payment.controller.ts` — `class PaymentController`
Bridges HTTP requests to `PaymentService` and `RefundService`.
- **Constructor**
  - Creates `PaymentService` and `RefundService` instances.

- **`createPayment(req, res)`**
  - Calls `PaymentService.createPayment(req.body)`.
  - Returns `201` `{ success:true, data: result }` or `400` on error.

- **`getPaymentByOrder(req, res)`**
  - Calls `PaymentService.getPaymentByOrderId(req.params.orderId)`.
  - Returns `404` if not found.

- **`getPaymentById(req, res)`**
  - Calls `PaymentService.getPaymentById(req.params.id)`.
  - Returns `404` if not found.

- **`getPaymentsByUser(req, res)`**
  - Parses `limit`/`offset` from query, calls `PaymentService.getPaymentsByUserId`.

- **`getEligibleForSettlement(req, res)`**
  - Parses `periodStart`/`periodEnd` from body and calls `PaymentService.findEligibleForSettlement`.

- **`getPaymentStats(req, res)`**
  - Parses `startDate`/`endDate` from body and calls `PaymentService.getPaymentStats`.

- **`createRefund(req, res)`**
  - Calls `RefundService.createRefund(req.body)`.

- **`getRefundById(req, res)`**
  - Calls `RefundService.getRefundById(req.params.id)`; returns `404` if missing.

- **`getRefundsByOrder(req, res)`**
  - Calls `RefundService.getRefundsByOrderId(req.params.orderId)`.

#### `src/controllers/webhook.controller.ts` — `class WebhookController`
Handles external callbacks from Xendit.
- **Constructor**
  - Creates a `PaymentService`.

- **`handleXenditCallback(req, res)`**
  - Verifies signature: `CryptoUtils.verifyXenditWebhook(rawBody, receivedSignature, verificationToken)`.
  - Ensures idempotency by checking existing `PaymentGatewayLog` entries for the event.
  - Finds the `Payment` by `gatewayTransactionId = callbackData.id`.
  - Logs webhook into `paymentGatewayLog`.
  - If `PAID` → calls `PaymentService.handlePaidCallback(callbackData)`.
  - If `EXPIRED` and payment pending → sets `Payment.status = expired`, writes `serviceOutbox` event `payment.expired`.

#### `src/controllers/transaction.controller.ts` — `class TransactionController`
Exposes read-only ledger views via `TransactionLedgerService`.
- **Constructor**
  - Creates `TransactionLedgerService`.
- **`getOrderTransactionHistory(req, res)`**
  - Calls `getOrderTransactionHistory(orderId)`.
- **`getPaymentTransactionHistory(req, res)`**
  - Calls `getPaymentTransactionHistory(paymentId)`.
- **`getFactoryTransactionSummary(req, res)`**
  - Requires `startDate` and `endDate` query; calls `getFactoryTransactionSummary(factoryId, start, end)`.
- **`getTransactionSummary(req, res)`**
  - Requires `startDate` and `endDate` query; calls `getTransactionSummary(start, end)`.
- **`getRecentTransactions(req, res)`**
  - Parses pagination (`limit`, `offset`) and calls `getRecentTransactions(limit, offset)`.
- **`findByCode(req, res)`**
  - Looks up a payment/refund by code (PAY-… or REF-…) via `findByCode(transactionCode)`.

#### `src/controllers/admin.controller.ts` — `class AdminController`
Admin dashboards and operations using Prisma directly.
- **`getAllPayments(req, res)`**
  - Builds a `where` filter from query params; returns paginated payments including refunds and recent gateway logs.
- **`getPaymentDetails(req, res)`**
  - Returns a single payment including all refunds and gateway logs.
- **`getAllRefunds(req, res)`**
  - Returns paginated refunds including a minimal payment projection.
- **`processRefund(req, res)`**
  - Validates `action` (approve/reject) using `express-validator`’s `validationResult`.
  - Approve: updates refund to `approved`, sets payment status `refunded`.
  - Reject: updates refund to `rejected` with reason.
  - Note: it reads `(req as any).user?.id` but no auth middleware is mounted by default.
- **`getPaymentAnalytics(req, res)`**
  - Uses Prisma `groupBy` and `aggregate` to compute totals by status/method and revenue.
- **`getSettlementRecords(req, res)`**
  - Returns paginated settlement records.
- **`getGatewayLogs(req, res)`**
  - Returns paginated gateway logs, filtered by paymentId/action/date range.

---

### Services (`src/services/*.service.ts`)

#### `src/services/payment.service.ts` — `class PaymentService`
Core business logic for payments.

- **Constructor**
  - Instantiates `PaymentRepository`.

- **`private fetchUser(userId)`**
  - Calls `GET ${AUTH_SERVICE_URL}/api/auth/users/${userId}`.
  - Throws “User not found” on 404, otherwise wraps errors.

- **`private fetchOrder(orderId)`**
  - Calls `GET ${ORDER_SERVICE_URL}/api/orders/${orderId}`.
  - Throws “Order not found” on 404.

- **`private updateOrderStatus(orderId, newStatus)`**
  - Calls `PUT ${ORDER_SERVICE_URL}/api/orders/${orderId}/status` with `{ newStatus }`.

- **`createPayment(data: CreatePaymentDTO)`**
  - Idempotency: if `idempotencyKey` matches an existing `Payment.idempotencyKey`, returns the existing payment (regardless of status).
  - Fetches user to populate invoice customer fields; uses placeholder email if missing.
  - Builds Xendit `CreateInvoiceRequest` (externalId, amount, payer email, invoiceDuration, redirect URLs).
  - Calls `xenditInvoiceClient.createInvoice({ data: invoiceData })`.
  - Persists `Payment` via `PaymentRepository.create(...)`.

- **`handlePaidCallback(callbackData)`**
  - Looks up payment by gateway transaction ID.
  - If already `paid`, returns early.
  - Calculates gateway fee from `fees_paid_amount`.
  - Marks payment paid via `PaymentRepository.markPaid(...)` and stores gatewayResponse in metadata.
  - Calls `updateOrderStatus(orderId, 'paid')`.
  - Sends notification via `sendPaymentNotification(userId, orderId, 'success')`.

- **`handleExpiredCallback(callbackData)`**
  - Looks up payment and marks it expired if still pending.
  - Note: webhook controller currently handles EXPIRED itself instead of calling this method.

- **`getPaymentByOrderId(orderId)`** → repository `findByOrderId`
- **`getPaymentById(paymentId)`** → repository `findById`
- **`getPaymentsByUserId(userId, options)`** → repository `findByUserId`
- **`findEligibleForSettlement(periodStart, periodEnd)`** → repository `findEligibleForSettlement`
- **`getPaymentStats(startDate, endDate)`** → repository `getPaymentStats`

- **`private sendPaymentNotification(userId, orderId, status)`**
  - Attempts to fetch order to include `order_number` in message.
  - Uses `notificationClient.sendNotification(...)`.
  - Never throws (notification failures shouldn’t break payment flow).

- **`private generatePlaceholderEmail(phoneNumber)`**
  - Generates `noreply+<digits>@<domain>` for users without email.

#### `src/services/refund.service.ts` — `class RefundService`
Creates and optionally processes refunds.

- **Constructor**
  - Instantiates `RefundRepository` and `PaymentRepository`.

- **`createRefund(data: CreateRefundDTO)`**
  - Validates payment exists and is `paid`.
  - Prevents duplicates by checking for refunds in `pending/approved/processing`.
  - Creates refund via `RefundRepository.create`.

- **`processRefund(refundId)`**
  - Loads refund + payment via `RefundRepository.findById`.
  - Moves status to `processing`, then processes by payment method:
    - if `paymentMethod` starts with `ewallet_` → `processEwalletRefund(...)` (calls Xendit HTTP API)
    - else → `processBankRefund(...)` (manual placeholder)
  - Marks refund completed + payment refunded; updates order status to `refunded`; notifies user.
  - On failure: marks refund failed + sends “failed” notification, then rethrows.

- **`getRefundById(refundId)`** → repository `findById`
- **`getRefundsByOrderId(orderId)`** → repository `findByOrderId`
- **`getRefundsByUserId(userId)`** → repository `findByUserId`

- **`private processEwalletRefund(payment, refund)`**
  - Calls `POST https://api.xendit.co/ewallets/charges/{chargeId}/refunds` using basic auth (secret key).
  - Maps error statuses (400/404/409) to readable messages.

- **`private processBankRefund(payment, refund)`**
  - Returns a “PENDING_MANUAL_REVIEW” response (no external API call).

- **`private updateOrderStatus(orderId, newStatus)`**
  - Same pattern as payment service (PUT to order-service).

- **`private sendRefundNotification(userId, orderId, status)`**
  - Sends refund completed/failed notification.

#### `src/services/transaction-ledger.service.ts` — `class TransactionLedgerService`
Aggregates payments/refunds/logs into a timeline and summaries.

- **`getOrderTransactionHistory(orderId)`**
  - Loads all payments for the order with gateway logs and refunds.
  - Builds a “timeline” array containing:
    - payment creation event
    - each gateway log (webhook or gateway call)
    - refund events
  - Sorts by `createdAt` descending.

- **`getPaymentTransactionHistory(paymentId)`**
  - Similar to order history but for a single payment; includes “payment_completed” event if `paidAt`.

- **`getFactoryTransactionSummary(factoryId, startDate, endDate)`**
  - Currently does not use `factoryId` to filter payments; returns aggregate stats for all paid payments in range and completed refunds in range.

- **`getTransactionSummary(startDate, endDate)`**
  - Aggregates totals for payments, refunds, and settlement records over a period.

- **`getRecentTransactions(limit, offset)`**
  - Fetches latest `PaymentGatewayLog` entries with payment/refund projections.

- **`findByCode(transactionCode)`**
  - Treats code as either:
    - `Payment.paymentNumber` → returns `{ type:'payment', data: payment }`
    - `Refund.refundNumber` → returns `{ type:'refund', data: refund }`
    - else returns `null`.

---

### Repositories (`src/repositories/*.repository.ts`)

#### `src/repositories/payment.repository.ts` — `class PaymentRepository`
Encapsulates Prisma operations for `Payment`.

- **`private generatePaymentNumber()`**
  - Creates `PAY-YYYYMMDD-<RANDOM>` (5 chars from base36).

- **`create(data, invoiceUrl, invoiceId)`**
  - Inserts a `Payment` with status `pending` and Xendit invoice identifiers.
  - Uses `expiresAt` from input or defaults to +24h.

- **`findById(id)`**
  - `payment.findUnique` including refunds.

- **`findByPaymentNumber(paymentNumber)`**
  - `payment.findUnique` by number.

- **`findByGatewayTransactionId(transactionId)`**
  - `payment.findFirst` by Xendit invoice ID.

- **`findByOrderId(orderId)`**
  - Latest payment for order (orderBy `createdAt desc`).

- **`findByUserId(userId, options)`**
  - Paginated payments for user.

- **`markPaid(id, gatewayFee, gatewayResponse)`**
  - Reads payment, computes `netAmount = amount - gatewayFee`.
  - Updates status `paid`, sets `paidAt`, and merges `metadata.gatewayResponse`.

- **`markExpired(id)`**: sets status `expired`.
- **`markFailed(id, reason, code?)`**: sets status `failed` with failure metadata.
- **`markCancelled(id)`**: sets status `cancelled` with `cancelledAt`.
- **`markRefunded(id)`**: sets status `refunded`.

- **`expirePendingPayments()`**
  - `updateMany` for `pending` payments whose `expiresAt < now` → status `expired`.

- **`findEligibleForSettlement(periodStart, periodEnd)`**
  - Returns `paid` payments with `paidAt` in `[start, end)`.

- **`getPaymentStats(startDate, endDate)`**
  - Returns grouped status counts and paid totals (sum amounts/fees/net).

#### `src/repositories/refund.repository.ts` — `class RefundRepository`
Encapsulates Prisma operations for `Refund`.

- **`private generateRefundNumber()`**
  - Creates `REF-YYYYMMDD-<RANDOM>` (5 chars from base36).

- **`create(data, payment)`**
  - Inserts refund with status `pending` and amount defaulting to full payment amount.

- **`findById(id)`**: `refund.findUnique` including `payment`.
- **`findByRefundNumber(refundNumber)`**: lookup by number.
- **`findByPaymentId(paymentId)`**: list refunds for a payment.
- **`findByOrderId(orderId)`**: list refunds for an order.
- **`findByUserId(userId)`**: list refunds for a user.

- **Lifecycle methods**
  - **`markApproved(id, approvedBy)`**
  - **`markProcessing(id, gatewayRefundId?)`**
  - **`markCompleted(id)`**
  - **`markFailed(id, reason)`**
  - **`markRejected(id, rejectedBy, reason)`**

---

### Jobs (`src/jobs/*.ts`)

#### `src/jobs/index.ts`
Barrel re-export:
- `expirePaymentsJob`, `weeklySettlementJob`, `dailyReconciliationJob`.

#### `src/jobs/expire-payments.ts`
- **`expirePaymentsJob()`**
  - Updates all `Payment` rows where `status='pending'` and `expiresAt < now` to `expired`.
  - Returns `{ expiredCount, processedAt }`.
  - Can run as standalone script (`node/tsx src/jobs/expire-payments.ts`).

#### `src/jobs/reconciliation.ts`
- **`dailyReconciliationJob({ date, dryRun }?)`**
  - Computes daily totals for paid payments and completed refunds for a day (default: yesterday).
  - Checks discrepancies using gateway data from latest webhook log or `payment.metadata.gatewayResponse`.
  - If not dry run: writes a `SettlementRecord` with reconciliation results.
  - Supports CLI args: `--dry-run`, `--date=YYYY-MM-DD`.

#### `src/jobs/weekly-settlement.ts`
- **`weeklySettlementJob({ periodStart, periodEnd, dryRun }?)`**
  - Finds paid payments within a period (default last 7 days).
  - Groups by `factoryId` from `payment.metadata.factoryId` (or `'unknown'`).
  - For each factory, calculates totals and (if not dryRun):
    - writes a `SettlementRecord`
    - writes a `ServiceOutbox` event `settlement.completed`
  - Can run as standalone script; supports `--dry-run`.

---

### Client (`src/clients/notification.client.ts`)
Wraps notification-service calls.

- **`type NotificationType`**
  - Union of allowed notification type strings (payment/refund/order/etc).

- **`interface CreateNotificationPayload`**
  - Payload contract for `/api/notifications`.

- **`class NotificationClient`**
  - **`sendNotification(payload)`**
    - POSTs to `${NOTIFICATION_SERVICE_URL}/api/notifications` (5s timeout).
    - Logs and **swallows** errors (does not throw).
  - **`sendBatchNotifications(payloads)`**
    - Sends in parallel via `Promise.allSettled`.

- **`notificationClient`**
  - Singleton instance used by services.

---

### Utilities (`src/utils/*.ts`)

#### `src/utils/crypto.utils.ts` — `class CryptoUtils`
General crypto helpers used by webhook controller.
- **`verifyXenditWebhook(payload, receivedSignature, webhookVerificationToken)`**
  - Computes HMAC-SHA256 hex digest and compares with `timingSafeEqual`.
  - Returns `false` if missing signature/token, or any comparison errors (e.g., buffer length mismatch).
- **`generatePaymentCode()` / `generateRefundCode()` / `generateSettlementCode()` / `generateCode(prefix)`**
  - Helpers to generate identifiers with date + random suffix.
- **`hash(input)`**
  - SHA256 hash.
- **`generateToken(length=32)`**
  - Random bytes to hex token.
- **`verifyHmac(data, signature, secret)` / `generateHmac(data, secret)`**
  - Generic HMAC helpers.

#### `src/utils/payment.ts`
Lower-level helper functions (separate from `CryptoUtils`).
- **`verifyXenditSignature(webhookToken, payload, receivedSignature)`**
  - HMAC verification using JSON stringified payload.
- **`validatePaymentAmount(requestedAmount, paidAmount, tolerance=0)`**
  - Validates amounts are positive and within tolerance; returns `{ valid, error? }`.
- **`calculatePlatformFee(amount, feePercentage=2.5)`**
  - Returns rounded fee or `0` for negative inputs.
- **`isPaymentExpired(expiresAt)`**
  - `new Date() > expiresAt`.
- **`getPaymentExpiryMinutes(expiresAt)`**
  - Returns floor of (expiresAt - now) in minutes (can be negative).

#### `src/utils/payment.test.ts`
Jest tests covering `payment.ts` utilities:
- Signature verification
- Amount validation
- Fee calculation
- Expiry/time math

---

### Prisma generated client (`src/generated/prisma/*`)
These files are generated by `prisma generate` (see `package.json` script `db:generate` and `prisma/schema.prisma` generator output).

Files include (non-exhaustive but present in repo):
- `default.js` / `default.d.ts`
- `edge.js` / `edge.d.ts`
- `index.js` / `index.d.ts` / `index-browser.js`
- `runtime/*` (`edge.js`, `library.js`, `wasm.js`, etc.)
- `schema.prisma` (copy of schema used for generation)
- Prisma engine binaries e.g. `query_engine-windows.dll.node`

How it’s used:
- `src/lib/prisma.ts` imports `PrismaClient` from `../generated/prisma`.
- Repositories/services/controllers call `prisma.<model>.<operation>()`.

You generally should not edit these files by hand; regenerate them after schema changes.

## Quick “gotchas” worth knowing (observed in current code)
- **Port mismatch risk**: `src/index.ts` defaults `PORT` to `3006`, while Docker commonly exposes `3007`. Ensure your runtime env sets `PORT` consistently.
- **Gateway-trust dev fallback**: `gatewayAuth` / `gatewayOrInternalAuth` have a development-mode fallback to a default user. That’s convenient locally, but make sure `NODE_ENV` is not accidentally `development` in production.
- **Service still depends on auth-service for user profile**: even though JWT validation moved to the gateway, `PaymentService.fetchUser()` still calls `AUTH_SERVICE_URL` to build Xendit invoice customer fields.
- **Notification client default**: `NotificationClient` has a localhost default; in deployed environments you should always set `NOTIFICATION_SERVICE_URL`.

## Future cleanup / tech debt (nice to clean up later)
- **Remove redundant validation in `AdminController.processRefund`**: routes already run `validateRequest`, but the controller still calls `validationResult(req)` and returns a different error shape.
- **Standardize controller error style**: `PaymentController` uses an async wrapper and throws `AppError` types, while `AdminController` still uses per-method `try/catch` and ad-hoc `{ error: ... }` responses. Consider migrating admin handlers to `asyncHandler` + `AppError` for consistent API responses.
- **Standardize response envelopes**: admin endpoints often return `{ data: ... }` without `success: true`, while other endpoints return `{ success: true, data: ... }`.
- **Consider constant-time comparison for `x-gateway-key`**: current gateway auth compares strings directly. It’s usually fine, but you can use `timingSafeEqual` (with length check) for stricter parity with webhook token verification.
- **Consider tightening auth fallbacks**: the dev fallback in gateway auth is handy, but some teams prefer it behind an explicit flag (e.g. `ALLOW_DEV_AUTH_BYPASS=true`) to prevent misconfiguration.
- **Controller layering**: admin routes use Prisma directly; if you want cleaner boundaries, move logic into services/repositories over time.
- **Factory summary correctness**: `TransactionLedgerService.getFactoryTransactionSummary()` currently doesn’t filter by `factoryId` (it returns a global summary for the period).

## Outbox event coverage (what’s wired vs still missing)

This service uses the **transactional outbox pattern** via the `ServiceOutbox` table (`prisma/schema.prisma`) and the helper `src/services/outbox.service.ts`.

### Events currently emitted (wired)
- **`payment.created`**
  - Emitted by: `PaymentService.createPayment()` → `outboxService.paymentCreated(payment)`
- **`payment.paid`**
  - Emitted by: `PaymentService.handlePaidCallback()` → `outboxService.paymentPaid(updatedPayment)`
- **`payment.expired`**
  - Emitted by:
    - `PaymentService.handleExpiredCallback()` → `outboxService.paymentExpired(payment)`
    - `WebhookController.handleXenditCallback()` (EXPIRED path) → direct `prisma.serviceOutbox.create({ eventType: 'payment.expired', ... })`
- **`refund.requested`**
  - Emitted by: `RefundService.createRefund()` → `outboxService.refundRequested(refund)`
- **`refund.completed`**
  - Emitted by: `RefundService.processRefund()` success path → `outboxService.refundCompleted(...)`
- **`refund.failed`**
  - Emitted by: `RefundService.processRefund()` failure path → `outboxService.refundFailed(...)`
- **`refund.approved` / `refund.rejected`**
  - Emitted by: `AdminController.processRefund()` → `outboxService.refundApproved(...)` / `outboxService.refundRejected(...)`
- **`settlement.completed`**
  - Emitted by: `weeklySettlementJob()` → `prisma.serviceOutbox.create({ eventType: 'settlement.completed', ... })`

### Still missing (recommended to add)
These are common “important flows” that are not yet consistently emitted via the outbox:

- **Expiration cron / batch expiration should emit `payment.expired`**
  - Current behavior:
    - `PaymentRepository.expirePendingPayments()` (used by `src/index.ts` cron) does an `updateMany` and does **not** write outbox rows.
    - `src/jobs/expire-payments.ts` does an `updateMany` and does **not** write outbox rows.
  - Recommended:
    - Update the job/cron flow to (1) fetch the IDs to expire, (2) update them, (3) write an outbox row per expired payment (or a batch event, if you prefer).

- **Payment failure/cancellation should emit events**
  - `src/services/outbox.service.ts` supports:
    - `payment.failed`
    - `payment.cancelled`
  - Recommended:
    - Wherever you call `PaymentRepository.markFailed(...)`, also call `outboxService.paymentFailed(...)`.
    - Wherever you call `PaymentRepository.markCancelled(...)`, also call a `payment.cancelled` publisher (currently no helper method is implemented for `payment.cancelled` in `OutboxService`).

- **Refund processing state events (optional but useful)**
  - `src/services/outbox.service.ts` declares event types:
    - `refund.processing`
  - Current behavior:
    - `RefundService.processRefund()` transitions refund to `processing`, but does not emit `refund.processing`.
  - Recommended:
    - Emit `refund.processing` when the refund enters processing, especially if downstream services need to show “refund in progress”.

### Consistency reminders (also worth addressing)
- **Prefer one outbox path (`outboxService`)**
  - Some flows write outbox rows via `outboxService`, while others write directly via `prisma.serviceOutbox.create(...)`.
  - Recommended:
    - Standardize on `outboxService.publish(...)` everywhere so payload shapes and timestamps stay consistent.

- **Transactional outbox**
  - Ideal pattern: write the domain state change **and** the outbox row in the **same DB transaction** (`prisma.$transaction`).
  - Many flows currently do “update, then insert outbox” as two separate operations.
