// =============================================================================
// PAYMENT SERVICE DATABASE SCHEMA
// Service: payment-service (Port 3007)
// Database: payment_db
// Owner: Payments, refunds, payment methods, gateway logs
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// PAYMENTS
// =============================================================================

model Payment {
  id                   String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentNumber        String        @unique @db.VarChar(50) // PAY-20260115-XXXXX
  orderId              String        @db.Uuid // Reference to Order Service
  userId               String        @db.Uuid // Reference to Auth Service
  // Amounts
  amount               Decimal       @db.Decimal(15, 2)
  gatewayFee           Decimal       @default(0) @db.Decimal(15, 2)
  netAmount            Decimal       @db.Decimal(15, 2) // Amount - gatewayFee
  currency             String        @default("IDR") @db.VarChar(3)
  // Payment method
  paymentMethod        PaymentMethod
  paymentMethodDetail  String?       @db.VarChar(100) // e.g., "BCA Virtual Account"
  // Gateway info (Xendit)
  paymentGateway       String        @default("xendit") @db.VarChar(50)
  gatewayTransactionId String?       @db.VarChar(255)
  gatewayReferenceId   String?       @db.VarChar(255)
  gatewayInvoiceUrl    String?
  // Virtual account / payment details
  virtualAccountNumber String?       @db.VarChar(50)
  qrCodeUrl            String?
  paymentCode          String?       @db.VarChar(50)
  // Status
  status               PaymentStatus @default(pending)
  failureReason        String?       @db.VarChar(500)
  failureCode          String?       @db.VarChar(100)
  // Timestamps
  expiresAt            DateTime?     @db.Timestamptz(6)
  paidAt               DateTime?     @db.Timestamptz(6)
  cancelledAt          DateTime?     @db.Timestamptz(6)
  // Wallet payment (if applicable)
  walletId             String?       @db.Uuid
  walletTransactionId  String?       @db.Uuid
  // Idempotency
  idempotencyKey       String        @unique @db.VarChar(100)
  // Metadata
  metadata             Json?
  createdAt            DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime      @updatedAt @db.Timestamptz(6)

  gatewayLogs PaymentGatewayLog[]
  refunds     Refund[]

  @@index([paymentNumber])
  @@index([orderId])
  @@index([userId])
  @@index([gatewayTransactionId])
  @@index([status])
  @@index([createdAt])
  @@map("payment")
}

// =============================================================================
// PAYMENT GATEWAY LOGS (Audit trail for Xendit API calls)
// =============================================================================

model PaymentGatewayLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentId     String?  @db.Uuid
  refundId      String?  @db.Uuid
  // Request details
  action        String   @db.VarChar(100) // "create_invoice", "get_payment", etc.
  requestMethod String   @db.VarChar(10)
  requestUrl    String   @db.VarChar(500)
  requestBody   Json?
  requestHeaders Json?
  // Response details
  responseStatus Int?
  responseBody   Json?
  responseHeaders Json?
  // Timing
  durationMs    Int?
  // Error tracking
  errorMessage  String?
  errorCode     String?  @db.VarChar(100)
  // Webhook info (if applicable)
  isWebhook     Boolean  @default(false)
  webhookType   String?  @db.VarChar(100)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)

  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  refund  Refund?  @relation(fields: [refundId], references: [id], onDelete: SetNull)

  @@index([paymentId])
  @@index([refundId])
  @@index([createdAt])
  @@map("payment_gateway_log")
}

// =============================================================================
// REFUNDS
// =============================================================================

model Refund {
  id                   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  refundNumber         String       @unique @db.VarChar(50) // REF-20260115-XXXXX
  paymentId            String       @db.Uuid
  orderId              String       @db.Uuid // Reference to Order Service
  returnId             String?      @db.Uuid // Reference to Order Service Return
  userId               String       @db.Uuid
  // Amounts
  amount               Decimal      @db.Decimal(15, 2)
  currency             String       @default("IDR") @db.VarChar(3)
  // Refund method
  refundMethod         RefundMethod
  // Gateway info
  gatewayRefundId      String?      @db.VarChar(255)
  // Status
  status               RefundStatus @default(pending)
  failureReason        String?      @db.VarChar(500)
  // Details
  reason               String?      @db.VarChar(500)
  notes                String?
  // Timestamps
  approvedAt           DateTime?    @db.Timestamptz(6)
  approvedBy           String?      @db.Uuid
  processedAt          DateTime?    @db.Timestamptz(6)
  completedAt          DateTime?    @db.Timestamptz(6)
  rejectedAt           DateTime?    @db.Timestamptz(6)
  rejectedBy           String?      @db.Uuid
  rejectionReason      String?      @db.VarChar(500)
  // Idempotency
  idempotencyKey       String       @unique @db.VarChar(100)
  createdBy            String?      @db.Uuid
  createdAt            DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime     @updatedAt @db.Timestamptz(6)

  payment     Payment             @relation(fields: [paymentId], references: [id])
  gatewayLogs PaymentGatewayLog[]

  @@index([refundNumber])
  @@index([paymentId])
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("refund")
}

// =============================================================================
// SAVED PAYMENT METHODS
// =============================================================================

model SavedPaymentMethod {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String        @db.Uuid
  paymentMethod     PaymentMethod
  // Card details (tokenized)
  cardType          String?       @db.VarChar(20) // visa, mastercard
  cardLast4         String?       @db.VarChar(4)
  cardExpMonth      Int?
  cardExpYear       Int?
  cardholderName    String?       @db.VarChar(255)
  gatewayTokenId    String?       @db.VarChar(255) // Xendit card token
  // Bank account details
  bankCode          String?       @db.VarChar(20)
  bankAccountLast4  String?       @db.VarChar(4)
  // Ewallet
  ewalletType       String?       @db.VarChar(50) // ovo, gopay, dana
  ewalletPhone      String?       @db.VarChar(20)
  // Display
  displayName       String?       @db.VarChar(100)
  isDefault         Boolean       @default(false)
  // Status
  isActive          Boolean       @default(true)
  lastUsedAt        DateTime?     @db.Timestamptz(6)
  createdAt         DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @db.Timestamptz(6)
  deletedAt         DateTime?     @db.Timestamptz(6)

  @@index([userId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("saved_payment_method")
}

// =============================================================================
// DAILY SETTLEMENT RECORDS
// =============================================================================

model SettlementRecord {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  settlementDate  DateTime @db.Date
  paymentGateway  String   @db.VarChar(50)
  // Totals
  totalPayments   Int
  totalAmount     Decimal  @db.Decimal(15, 2)
  totalFees       Decimal  @db.Decimal(15, 2)
  netAmount       Decimal  @db.Decimal(15, 2)
  // Refunds
  totalRefunds    Int
  refundAmount    Decimal  @db.Decimal(15, 2)
  // Status
  isReconciled    Boolean  @default(false)
  reconciledAt    DateTime? @db.Timestamptz(6)
  reconciledBy    String?  @db.Uuid
  notes           String?
  createdAt       DateTime @default(now()) @db.Timestamptz(6)

  @@unique([settlementDate, paymentGateway])
  @@index([settlementDate])
  @@map("settlement_record")
}

// =============================================================================
// COMMISSION LEDGER (0.5% commission tracking for social commerce)
// =============================================================================

model CommissionLedger {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ledgerNumber      String            @unique @db.VarChar(50) // COM-20260127-XXXXX
  orderId           String            @db.Uuid // Reference to Order Service
  orderNumber       String            @db.VarChar(50)
  sellerId          String            @db.Uuid // Reference to Seller Service
  paymentId         String?           @db.Uuid // Reference to Payment
  // Amounts
  orderAmount       Decimal           @db.Decimal(15, 2) // Total order amount from this seller
  commissionRate    Decimal           @db.Decimal(5, 4)  // e.g., 0.0050 for 0.5%
  commissionAmount  Decimal           @db.Decimal(15, 2) // Calculated commission
  // Payout reference (when commission is deducted from seller payout)
  settlementId      String?           @db.Uuid // Reference to seller settlement/payout
  // Status
  status            CommissionStatus  @default(pending)
  collectedAt       DateTime?         @db.Timestamptz(6)
  // Timestamps
  orderCompletedAt  DateTime?         @db.Timestamptz(6) // Commission becomes collectible when order completes
  createdAt         DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime          @updatedAt @db.Timestamptz(6)

  @@unique([orderId, sellerId]) // Prevent duplicate commission per seller per order
  @@index([orderId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("commission_ledger")
}

// =============================================================================
// SERVICE OUTBOX (For Kafka event messaging)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100)
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum PaymentMethod {
  bank_transfer
  virtual_account
  credit_card
  debit_card
  ewallet_ovo
  ewallet_gopay
  ewallet_dana
  ewallet_linkaja
  ewallet_shopeepay
  qris
  retail_outlet
  wallet // LAKOO wallet
}

enum PaymentStatus {
  pending
  awaiting_payment
  paid
  failed
  expired
  cancelled
  refunded
  partially_refunded
}

enum RefundMethod {
  original_payment // Refund to original payment method
  wallet           // Refund to LAKOO wallet
  bank_transfer    // Manual bank transfer
}

enum RefundStatus {
  pending
  approved
  processing
  completed
  failed
  rejected
}

enum CommissionStatus {
  pending           // Order not yet completed
  collectible       // Order completed, ready to collect on settlement
  collected         // Deducted from seller payout
  waived            // Commission waived (promo, partnership, etc.)
  refunded          // Order was refunded, commission voided
}
