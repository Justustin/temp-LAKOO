# Logistic Service Documentation (`backend/services/logistic-service`)

This document explains **each file** in the logistic-service, and (for source files) explains how it relates to **routes → controllers → services → repositories → database**. It also includes a **thorough middleware** section and an **endpoint map**.

> Notes:
> - `node_modules/` is third‑party and not documented here.
> - `src/generated/prisma/` is **Prisma generated output**; it’s documented as autogenerated (not handwritten business logic).

## High-level overview

### What this service does
- **Creates and manages shipments** for orders (`Shipment` table).
- **Tracks shipment events** from couriers (webhook + manual/admin + internal updates) (`TrackingEvent` table).
- **Provides shipping rates** using courier configuration + a **rate cache**, and fetches missing rates from **Biteship**.
- **Exposes admin endpoints** to manage shipments/couriers/warehouses.
- **Provides internal endpoints** for service-to-service calls (e.g. order service).
- **Emits outbox events** (`ServiceOutbox`) for eventual async delivery (Kafka/messaging later).

### Layering (how code is organized)
- **Routes** (`src/routes/*.routes.ts`): Express endpoints and middleware wiring (auth/validation).
- **Controllers** (`src/controllers/*.controller.ts`): HTTP handlers; parse request, call service/repo, return JSON.
- **Services** (`src/services/*.service.ts`): business logic; calls repositories and external services (Order/Notification/Biteship).
- **Repositories** (`src/repositories/*.repository.ts`): database access via Prisma for an aggregate.
- **Database** (`prisma/schema.prisma`): Prisma schema for shipments, tracking events, couriers, warehouses, rate cache, outbox.
- **Middleware** (`src/middleware/*.ts`): gateway-trust auth, zod validation, error handler.

### Request flow (typical)
1. **Route** mounts auth and validates request (Zod via `validate(...)`).
2. **Controller** calls a **Service** method.
3. **Service** calls repositories and/or external services (Biteship / Order / Notification).
4. Errors bubble to the centralized `errorHandler` middleware.

## Environment variables (what the code expects)

Common variables referenced across files:
- **`PORT`**: Express listen port (defaults to `3009` in `src/index.ts`).
- **`LOGISTICS_DATABASE_URL`**: Postgres connection string for Prisma.
- **`GATEWAY_SECRET_KEY`**: shared secret to verify requests came from the API Gateway (`x-gateway-key` header).
- **`INTERNAL_API_KEY`**: API key for internal service-to-service calls (`x-internal-api-key` header).
- **`ALLOWED_ORIGINS`**: comma-separated CORS allowlist (defaults to `http://localhost:3000`).

External services:
- **`BITESHIP_BASE_URL`**: Biteship base URL (defaults to `https://api.biteship.com/v1`).
- **`BITESHIP_API_KEY`**: Biteship API key (used for rate/order/tracking calls).
- **`BITESHIP_WEBHOOK_SECRET`**: secret for verifying `x-biteship-signature` (HMAC-SHA256 hex).
- **`ORDER_SERVICE_URL`**: order service base URL (defaults to `http://localhost:3005`).
- **`NOTIFICATION_SERVICE_URL`**: notification service base URL (defaults to `http://localhost:3003`).
  - Note: the repo’s microservice plan uses order-service `3006` and notification-service `3008`. Prefer setting these explicitly in env for Docker/EC2.

Caching:
- **`RATE_CACHE_TTL_HOURS`**: TTL (hours) for shipping rate cache (defaults to `24`).

## Endpoint → Controller → Service/Repo map

### Shipments (`/api/shipments/*`) — `src/routes/shipment.routes.ts`
- **GET `/api/shipments/track/:trackingNumber`** (public)
  - Controller: `trackShipment`
  - Service: `ShipmentService.getShipmentByTrackingNumber`
  - Repo: `ShipmentRepository.findByTrackingNumber`

- **POST `/api/shipments/`** (gateway auth)
  - Middleware: `authenticate` (gateway-trust), `validate(createShipmentSchema)`
  - Controller: `createShipment`
  - Service: `ShipmentService.createShipment`
  - Repo: `ShipmentRepository.create`, `WarehouseRepository.findDefault` (if origin omitted)
  - Outbox: `outboxService.shipmentCreated`

- **GET `/api/shipments/user`** (gateway auth)
  - Controller: `getUserShipments`
  - Service/Repo: `ShipmentRepository.findByUserId` (pagination)

- **GET `/api/shipments/:id`** (gateway auth; user-owned or admin)
  - Controller: `getShipmentById`
  - Service/Repo: `ShipmentRepository.findById`

- **GET `/api/shipments/order/:orderId`** (gateway auth; user-owned or admin)
  - Controller: `getShipmentByOrderId`
  - Service/Repo: `ShipmentRepository.findByOrderId`

- **GET `/api/shipments/:id/tracking`** (gateway auth; user-owned or admin)
  - Controller: `getTrackingHistory`
  - Repo: `TrackingRepository.findByShipmentId`

- **POST `/api/shipments/:id/cancel`** (gateway auth; user-owned or admin)
  - Controller: `cancelShipment`
  - Service: `ShipmentService.cancelShipment`
  - Repo: `ShipmentRepository.markCancelled`
  - Outbox: `outboxService.shipmentStatusChanged`

### Rates (`/api/rates/*`) — `src/routes/rate.routes.ts`
- **POST `/api/rates`**
  - Middleware: `validate(getRatesSchema)`
  - Controller: `getShippingRates`
  - Service: `RateService.getRates` (alias → `getShippingRates`)
  - Repos: `CourierRepository.findAllCouriers`, `RateCacheRepository.get/bulkSet`
  - External: `biteshipClient.getRates` for cache misses

- **GET `/api/rates/couriers`**
  - Controller: `getAvailableCouriers`
  - Service: `RateService.getActiveCouriers` (returns safe projection; no API keys)

- **POST `/api/rates/estimate`**
  - Controller: `getQuickEstimate` (returns `cheapest` + `fastest`)

### Webhooks (`/api/webhooks/*`) — `src/routes/webhook.routes.ts`
- **POST `/api/webhooks/biteship`**
  - Controller: `handleBiteshipWebhook`
  - Signature verification:
    - Reads raw body (`req.rawBody`) captured by `express.json({ verify })` in `src/index.ts`
    - Verifies `x-biteship-signature` using HMAC-SHA256 hex with `BITESHIP_WEBHOOK_SECRET`
  - Repo/Service: finds shipment by `biteshipOrderId` or tracking number, adds tracking event, updates status

- **POST `/api/webhooks/biteship/test`** (dev-only helper)
  - Controller: `testBiteshipWebhook` (returns 404 in production)

### Admin (`/api/admin/*`) — `src/routes/admin.routes.ts`
Route-level auth: `authenticate` + `requireAdmin`.

Shipments:
- **GET `/api/admin/shipments`** → `getAllShipments` → `ShipmentService.getAllShipments`
- **PUT `/api/admin/shipments/:id`** → `updateShipment` → `ShipmentService.updateShipment`
- **PUT `/api/admin/shipments/:id/status`** → `updateShipmentStatus` → `ShipmentService.updateShipmentStatus`
- **POST `/api/admin/shipments/:id/tracking`** → `addTrackingEvent` → `ShipmentService.addTrackingEvent`
- **POST `/api/admin/shipments/:id/delivered`** → `markDelivered` → `ShipmentService.markDelivered`
- **POST `/api/admin/shipments/:id/failed`** → `markFailed` → `ShipmentService.markFailed`
- **GET `/api/admin/shipments/stats`** → `getShipmentStats` → `ShipmentRepository.getShipmentStats`

Couriers:
- **GET `/api/admin/couriers`** → `getAllCouriers` → `CourierRepository.findActive/findAll`
- **POST `/api/admin/couriers`** → `createCourier` → `CourierRepository.create`
- **PUT `/api/admin/couriers/:id`** → `updateCourier` → `CourierRepository.update`
- **POST `/api/admin/couriers/:id/toggle`** → `toggleCourier` → `CourierRepository.update`
- **POST `/api/admin/couriers/:id/services`** → `addCourierService` → `CourierRepository.addService`

Warehouses:
- **GET `/api/admin/warehouses`** → `getAllWarehouses` → `WarehouseRepository.findAll`
- **POST `/api/admin/warehouses`** → `createWarehouse` → `WarehouseRepository.create`
- **PUT `/api/admin/warehouses/:id`** → `updateWarehouse` → `WarehouseRepository.update`
- **POST `/api/admin/warehouses/:id/default`** → `setDefaultWarehouse` → `WarehouseRepository.setDefault`

### Internal (`/api/internal/*`) — `src/routes/internal.routes.ts`
Route-level auth: `requireInternalAuth` (expects `x-internal-api-key`).

- **POST `/api/internal/shipments`** → `createShipmentInternal` → `ShipmentService.createShipment`
- **POST `/api/internal/shipments/:id/book`** → `bookShipmentInternal` → `ShipmentService.bookShipment`
- **PUT `/api/internal/shipments/:id/status`** → `updateStatusInternal` → `ShipmentService.updateShipmentStatus`
- **GET `/api/internal/shipments/order/:orderId`** → `getByOrderIdInternal`
- **POST `/api/internal/rates`** → `getShippingRatesInternal` → `RateService.getRates`

## Middleware (thorough)

> Middleware files live under `src/middleware/`. Auth and validation are applied at the router level (see `src/routes/*.routes.ts`), and `errorHandler` is mounted in `src/index.ts`.

### `src/middleware/error-handler.ts`
Defines a consistent error model and the global error handler.

- **`AppError` + typed errors**
  - `BadRequestError` (400), `UnauthorizedError` (401), `ForbiddenError` (403), `NotFoundError` (404), `ConflictError` (409), `ShipmentError` (422)
- **`errorHandler(err, req, res, _next)`**
  - Logs method/path + message (+ stack in development)
  - Formats `AppError` consistently
  - Handles Prisma known errors (`P2002`, `P2025`)
  - Handles Zod validation errors (`ZodError`)
- **`asyncHandler(fn)`**
  - Promise wrapper for async Express handlers (not used everywhere yet)

### `src/middleware/auth.ts`
Implements gateway-trust auth and internal API key auth.

- **`gatewayAuth` / alias `authenticate`**
  - Verifies `x-gateway-key === GATEWAY_SECRET_KEY`
  - Requires `x-user-id`, optionally reads `x-user-role`
  - Dev fallback: if `NODE_ENV=development` and no `GATEWAY_SECRET_KEY`, allows a default dev user
- **`requireRole` / alias `requireAdmin`**
  - Requires a user and checks role membership (admin routes)
- **`internalServiceAuth` / alias `requireInternalAuth`**
  - Verifies `x-internal-api-key === INTERNAL_API_KEY`
- **`gatewayOrInternalAuth`**
  - Accepts either gateway-auth or internal API key auth

### `src/middleware/validation.ts`
Zod schemas + middleware wrapper.

- **Zod schemas**: `createShipmentSchema`, `getRatesSchema`, `updateShipmentStatusSchema`, etc.
- **`validate(schema)`**
  - Parses `req.body` and returns a consistent 400 shape on Zod validation errors.

## File-by-file documentation

### Root files

#### `package.json`
Defines scripts and dependencies.
- **`build`**
  - `pnpm run db:generate` → generates Prisma into `src/generated/prisma`
  - `tsc` → builds into `dist/`
  - `node scripts/copy-generated-prisma.mjs` → copies Prisma client into `dist/generated/prisma` so `node dist/index.js` works
- **`db:*`**
  - Prisma generate/migrate/push/studio/reset
- **`docker:*`**
  - Builds/runs the Docker image

#### `tsconfig.json`
TypeScript config:
- strict mode enabled
- emits declarations (used by other services/tools)
- excludes `**/*.test.ts`

#### `Dockerfile`
Multi-stage build:
- Builder: `pnpm install` + `pnpm run build`
- Production: installs prod deps and runs `node dist/index.js`

#### `docker-compose.yml`
Development stack:
- `logistic-service` + `logistic-db` (Postgres) + one-off `logistic-migrate` (uses `prisma db push` in this repo)

#### `prisma/schema.prisma`
Database models:
- `Shipment`, `TrackingEvent`, `CourierIntegration`, `CourierService`, `ShippingRateCache`, `WarehouseLocation`, `ServiceOutbox`

---

### `src/index.ts` (service entrypoint)
Sets up Express, Swagger, security headers, logging, routes, 404, and error handling.
- **Body parsing**
  - Uses `express.json({ verify })` to capture raw bodies into `req.rawBody` (needed for webhook signatures).
- **Health & docs**
  - `GET /health` returns JSON
  - `/api-docs` serves Swagger UI

### `src/config/swagger.ts`
Swagger OpenAPI generation via `swagger-jsdoc`.

### `src/config/biteship.ts`
Axios-based client wrapper for Biteship:
- `getRates()`, `createOrder()`, `getTracking()`, `cancelOrder()`

### `src/lib/prisma.ts`
Prisma client singleton setup.
- Imports Prisma client from `../generated/prisma`.
- **Important**: production runtime requires the Prisma client folder to be present under `dist/generated/prisma` (handled by the build copy script).

### Routes (`src/routes/*.routes.ts`)
Wires endpoints to controllers and applies auth/validation.

### Controllers (`src/controllers/*.controller.ts`)
Request handlers:
- `shipment.controller.ts`: user + internal shipment endpoints
- `rate.controller.ts`: rates and courier listing
- `webhook.controller.ts`: Biteship webhooks (+ dev test endpoint)
- `admin.controller.ts`: admin shipment/courier/warehouse operations

### Services (`src/services/*.service.ts`)
Core business logic:
- `ShipmentService`: shipment lifecycle, status transitions, notifications to order/notification services
- `RateService`: rate caching, courier config, Biteship lookups
- `OutboxService`: writes events into `ServiceOutbox`

### Repositories (`src/repositories/*.repository.ts`)
Prisma access:
- `ShipmentRepository`, `TrackingRepository`, `CourierRepository`, `WarehouseRepository`, `RateCacheRepository`

## Quick “gotchas” worth knowing
- **Prisma client path at runtime**: `node dist/index.js` expects Prisma under `dist/generated/prisma` (the build script copies it).
- **Webhook verification needs raw body**: do not remove `express.json({ verify })` or signatures will break.
- **Dev auth fallback**: gateway auth has a development-mode bypass; make sure production uses `NODE_ENV=production` and sets secrets.

## Future-me problems (gotchas / tech debt)

High-signal things that can bite you later:

- **Webhook verification must fail closed in production**
  - Always configure `BITESHIP_WEBHOOK_SECRET` in prod and require `x-biteship-signature`.
  - If you ever change body parsing, keep `req.rawBody` capture intact or signature checks will break.

- **Default warehouse under concurrency**
  - Admin “set default warehouse” can race and create multiple defaults unless serialized.
  - Current approach: repository uses a Postgres advisory transaction lock for default mutations.

- **Service URL defaults can silently point to the wrong service**
  - Prefer explicitly setting `ORDER_SERVICE_URL` and `NOTIFICATION_SERVICE_URL` in Docker/EC2.
  - Don’t rely on localhost defaults once you’re in a container network.

- **Transactional outbox guarantee**
  - Outbox writes are not always in the same DB transaction as the domain write.
  - If you need strict guarantees, pass a Prisma `tx` into outbox publishing like `warehouse-service` does.

- **Validation strategy**
  - This service currently uses Zod for most request bodies (and also has express-validator result handling).
  - Consider standardizing on one runtime validator long-term to avoid drift.

- **`db push` vs migrations**
  - Docker/dev uses `prisma db push` when there’s no `prisma/migrations/` history.
  - Before production, consider switching to real migrations (`prisma migrate dev` → `prisma migrate deploy`) so schema changes are versioned and repeatable.

- **DB init container command (`pnpm dlx` vs `npx`)**
  - In `docker-compose.yml`, the one-shot DB init container uses `pnpm dlx prisma db push`.
  - Depending on how the image is built, `pnpm` might not be available in the runtime container. A safer default is `npx prisma db push` (or build a dedicated “migrate” image that includes pnpm).

- **Webhook retry strategy**
  - Right now the webhook handler returns `200` even on exceptions to avoid retries.
  - That’s ok for “bad payload” cases, but for transient failures (DB unavailable, network blips) you may want to return `500` so Biteship retries.

- **Rate limiting for webhooks**
  - Consider rate limiting `/api/webhooks/biteship` to reduce abuse/DoS risk (especially if the endpoint is publicly reachable).

## Outbox event coverage (what’s emitted)
Outbox rows are written via `src/services/outbox.service.ts`:
- Shipment lifecycle: `shipment.created`, `shipment.booked`, `shipment.awaiting_pickup`, `shipment.picked_up`, `shipment.in_transit`, `shipment.at_destination_hub`, `shipment.out_for_delivery`, `shipment.delivered`, `shipment.failed`, `shipment.returned`, `shipment.cancelled`
- Tracking: `tracking.updated`

