# Address Service Documentation (`backend/services/address-service`)

This document explains **each file** in the address-service, and (for source files) explains how the logic relates to **routes → controllers → services → repositories → database**. It also includes a middleware section and an endpoint map.

> Notes:
> - `node_modules/` is third‑party and not documented here.
> - `src/generated/prisma/` is **Prisma generated output**; it’s documented as autogenerated (not handwritten business logic).

## High-level overview

### What this service does
- **User address CRUD** with soft-delete (`deletedAt`).
- **Default address** management (ensures only one default per user).
- **Address usage tracking** (mark address as used; increments `useCount`, updates `lastUsedAt`) for order placement analytics.
- **Indonesian location reference data** tables (Province/City/District/Village/PostalCode) exist in the DB schema for future/optional location endpoints.
- **Domain events**: writes integration events to `ServiceOutbox` (outbox pattern).

### Layering (how code is organized)
- **Routes** (`src/routes/*.routes.ts`): Express endpoints + request validation (via `express-validator`).
- **Controllers** (`src/controllers/*.controller.ts`): HTTP handlers; enforce access rules (user ownership vs internal).
- **Services** (`src/services/*.service.ts`): business logic; orchestrates repository + Prisma transactions + outbox events.
- **Repositories** (`src/repositories/*.repository.ts`): database access via Prisma.
- **Database schema** (`prisma/schema.prisma`): Prisma schema for addresses, location tables, validation cache, outbox.
- **Middleware** (`src/middleware/*.ts`): gateway/internal auth, validation result handling, centralized error handler.

### Request flow (typical)
1. **Route** applies auth middleware and validators.
2. **Controller** reads params/body, enforces authorization rules, and calls a **Service** method.
3. **Service** runs business logic (often inside a Prisma transaction), calls repository helpers, and writes outbox events.
4. Response returned; async errors bubble to the centralized `errorHandler`.

## Environment variables (what the code expects)

Variables referenced across files:
- **`PORT`**: Express listen port (defaults to `3010` via `src/config/env.ts`).
- **`NODE_ENV`**: affects dev auth bypass behavior (`development`/`test`/`production`).
- **`ADDRESS_DATABASE_URL`**: Postgres connection string used by Prisma (`prisma/schema.prisma`).
- **`GATEWAY_SECRET_KEY`**: shared secret to verify gateway traffic (`x-gateway-key` header).
- **`INTERNAL_API_KEY`**: API key for internal service-to-service calls (`x-internal-api-key` header).

## Local development

### Install & run
From repo root:
- **Install dependencies**:
  - `pnpm -C backend/services/address-service install`
- **Generate Prisma client**:
  - `pnpm -C backend/services/address-service db:generate`
- **Run migrations** (dev):
  - `pnpm -C backend/services/address-service db:migrate`
- **Start dev server**:
  - `pnpm -C backend/services/address-service dev`

### Build
The build produces `dist/` and copies Prisma generated output so runtime imports resolve:
- **Build**: `pnpm -C backend/services/address-service build`
- Under the hood, `build` runs:
  - `prisma generate`
  - `tsc`
  - `node scripts/copy-generated-prisma.mjs` (copies `src/generated/prisma` → `dist/generated/prisma`)

## Authentication model (gateway-trust + internal key)

This service assumes **JWT validation happens at the API Gateway**. The service verifies the request came from the gateway using a shared secret header:
- **Gateway traffic**:
  - `x-gateway-key`: must match `GATEWAY_SECRET_KEY`
  - `x-user-id`: required
  - `x-user-role`: optional (`user`, etc.)
- **Internal service-to-service traffic**:
  - `x-internal-api-key`: must match `INTERNAL_API_KEY`
  - optional `x-user-id` (defaults to `internal-service`)
  - the service sets `req.user.role = 'internal'` for internal-key traffic

> Dev-mode bypass: In `NODE_ENV=development`, if no key is configured, the middleware allows requests through with a `dev-user` identity. Do not deploy with `NODE_ENV=development`.

## Endpoint → Controller → Service/Repo map

All endpoints in this service are mounted under:
- **Base path**: `/api/addresses`
- **Routes file**: `src/routes/address.routes.ts`
- **Route-level auth**: `gatewayOrInternalAuth`
- **Validation**: `express-validator` validators + `validateRequest`

### Addresses (`/api/addresses/*`)

- **POST `/api/addresses/`** (create address)
  - Auth: gateway (user identity) or internal (service identity)
  - Controller: `AddressController.createAddress`
  - Service: `AddressService.createAddress`
  - Repo: `AddressRepository.create`
  - Notes:
    - The controller **overrides** any body `userId` with the authenticated `req.user.id`.
    - If `isDefault=true`, creation is transactional and unsets other defaults first.
  - Events: outbox `address.created`

- **GET `/api/addresses/user/:userId`** (list addresses)
  - Controller: `AddressController.getUserAddresses`
  - Service: `AddressService.getUserAddresses`
  - Repo: `AddressRepository.findByUserId`
  - Auth rules:
    - Users can only request their own `:userId`
    - Internal services can request any user

- **GET `/api/addresses/user/:userId/default`** (default address)
  - Controller: `AddressController.getDefaultAddress`
  - Service: `AddressService.getDefaultAddress`
  - Repo: `AddressRepository.findDefaultByUserId`
  - Auth rules: same as list addresses

- **GET `/api/addresses/:id`** (get address by id)
  - Controller: `AddressController.getAddress`
  - Service: `AddressService.getAddress`
  - Repo: `AddressRepository.findById`
  - Auth rules:
    - Users can only access their own address
    - Internal services can access any

- **PATCH `/api/addresses/:id`** (update address)
  - Controller: `AddressController.updateAddress`
  - Service: `AddressService.updateAddress`
  - Repo: `AddressRepository.update`, `AddressRepository.setAsDefault` (if `isDefault=true`)
  - Notes:
    - Ownership is enforced in the service.
    - Default switching is serialized per-user (uses a DB transaction + Postgres advisory lock) to avoid multiple defaults under concurrency.
  - Events:
    - outbox `address.updated`
    - if `isDefault=true`: also emits `address.set_default`

- **POST `/api/addresses/:id/set-default`** (set default)
  - Controller: `AddressController.setDefaultAddress`
  - Service: `AddressService.setDefaultAddress`
  - Repo: `AddressRepository.setAsDefault` (transactional)
  - Notes:
    - Default switching is serialized per-user (uses a DB transaction + Postgres advisory lock) to avoid multiple defaults under concurrency.
  - Events:
    - outbox `address.set_default`
    - outbox `address.updated`

- **DELETE `/api/addresses/:id`** (soft delete)
  - Controller: `AddressController.deleteAddress`
  - Service: `AddressService.deleteAddress`
  - Repo:
    - `AddressRepository.softDelete` (normal)
    - `AddressRepository.softDeleteWithDefaultSwitch` (when deleting the default)
  - Notes:
    - Prevents deleting the last remaining address for a user.
    - If deleting the default address, it selects another address and switches default inside a transaction.
  - Events: outbox `address.deleted`

- **POST `/api/addresses/:id/mark-used`** (internal only)
  - Middleware: `internalOnly`
  - Controller: `AddressController.markAddressAsUsed`
  - Service: `AddressService.markAddressAsUsed`
  - Repo: `AddressRepository.markAsUsed`
  - Notes:
    - Intended for **order placement** to track usage stats.
    - Not intended for end-user clients.

## Response format & error handling

Successful responses are generally:
- `200` / `201`:
  - `{ "success": true, "data": ... }`
- `204` delete:
  - empty body

Errors are formatted by `src/middleware/errorHandler.ts`:
- `{ "success": false, "error": "Message" }`
- In `NODE_ENV=development`, stack traces may be included.

## Middleware

Middleware files live under `src/middleware/`.

### `src/middleware/auth.ts`
Implements authentication/authorization for HTTP endpoints.

- **`gatewayOrInternalAuth`**
  - Accepts either:
    - gateway traffic (`x-gateway-key` matches `GATEWAY_SECRET_KEY` and requires `x-user-id`)
    - internal traffic (`x-internal-api-key` matches `INTERNAL_API_KEY`)
  - Sets `req.user = { id, role }`.

- **`internalOnly`**
  - Only allows requests where `req.user.role === 'internal'`.
  - Used for the internal usage-tracking endpoint: `POST /api/addresses/:id/mark-used`.

### `src/middleware/validation.ts`
Provides runtime validation for `express-validator`.

- **`validateRequest(req, res, next)`**
  - If validators failed: responds `400` with `{ success: false, error: 'Validation failed', details: [...] }`.
  - Otherwise calls `next()`.

Validator arrays are used directly in `src/routes/address.routes.ts`, including:
- `createAddressValidators`
- `updateAddressValidators`
- `idParamValidator`, `userIdParamValidator`

### `src/middleware/errorHandler.ts`
Centralized Express error handler.

- Reads `err.statusCode` if present (custom errors in the service layer set it).
- Defaults to `500`.
- Logs the error and returns a consistent JSON error response.

## Domain events (outbox pattern)

### Outbox table
The Prisma schema defines `ServiceOutbox` to store events for later publishing (e.g., Kafka migration).

### Event publisher
`src/services/outbox.service.ts` writes events to `serviceOutbox`:
- `address.created`
- `address.updated`
- `address.deleted`
- `address.set_default` (emitted by default-switching flows)

> Note: This service currently **writes** outbox records; a background publisher/consumer loop is not implemented in this service folder.

## Database schema (Prisma)

File: `prisma/schema.prisma`

Key models:
- **`Address`**
  - Soft delete via `deletedAt`.
  - `isDefault` indicates default address (service logic ensures only one default per user).
  - Usage tracking: `lastUsedAt`, `useCount`.
- **Location reference tables**
  - `Province`, `City`, `District`, `Village`, `PostalCode`
  - Present for consistent address normalization/search and courier mapping.
- **`AddressValidationCache`**
  - Cache for validation/geocoding results (schema present; feature integration can be added).
- **`ServiceOutbox`**
  - Outbox pattern storage for integration events.

## Future-me problems (gotchas / tech debt)

High-signal things that can bite you later:

- **Default address invariants under concurrency**
  - Even with transactions, concurrent “set default” requests can create multiple defaults unless you serialize per user or enforce it in the DB.
  - Current approach: repository uses a **per-user Postgres advisory transaction lock** for default mutations.

- **Transactional outbox guarantee**
  - Today, address writes and outbox inserts are not universally wrapped in the same transaction.
  - If you need strict guarantees (no “address changed but no event”, and no “event without change”), refactor to pass a Prisma `tx` into outbox publishing like `warehouse-service` does.

- **CORS is permissive by default**
  - `src/index.ts` uses `cors()` with no origin allowlist.
  - For production, restrict origins (and consider credentials) based on your frontend domains.

- **`dist/` + Prisma generated client quirks**
  - This service copies `src/generated/prisma` into `dist/generated/prisma` at build time (see `scripts/copy-generated-prisma.mjs`).
  - If you move to Docker/CI builds, ensure the container build runs `prisma generate` and includes generated output (or adjust imports to avoid needing the copy step).

- **Internal endpoint safety (`POST /api/addresses/:id/mark-used`)**
  - It is guarded by `internalOnly`, which relies on `gatewayOrInternalAuth` correctly classifying internal calls.
  - Don’t expose `x-internal-api-key` to browsers; keep it server-to-server only.

## File-by-file guide

### `src/index.ts`
Service entrypoint:
- Loads env (`dotenv.config()`), validates config (`src/config/env.ts`), mounts middleware and routes.
- Mounts Swagger UI at `/api-docs`.
- Mounts routes at `/api/addresses`.
- Adds `errorHandler` and a JSON `404` fallback.

### `src/config/env.ts`
Central config validation:
- Requires `ADDRESS_DATABASE_URL` always.
- Requires `GATEWAY_SECRET_KEY` and `INTERNAL_API_KEY` in production.

### `src/config/swagger.ts`
OpenAPI spec via `swagger-jsdoc`:
- Defines security schemes:
  - `gatewayAuth` (`x-gateway-key`)
  - `internalAuth` (`x-internal-api-key`)
- Defines schemas:
  - `Address`, `CreateAddress`, `UpdateAddress`, `Error`

### `src/lib/prisma.ts`
Prisma client singleton:
- Imports the generated Prisma client from `src/generated/prisma` (via `../generated/prisma`).
- Reuses a global Prisma client in non-production to avoid hot-reload connection storms.

### `src/routes/address.routes.ts`
Route declarations + validators + Swagger annotations.

### `src/controllers/address.controller.ts`
HTTP handlers:
- Enforces ownership checks for reads (`GET /:id`, `GET /user/:userId`, `GET /user/:userId/default`).
- Derives `userId` from `req.user.id` for creation.

### `src/services/address.service.ts`
Business logic and invariants:
- Ownership checks for update/delete.
- Default switching logic.
- Prevents deleting the only address.
- Emits outbox events on create/update/delete.

### `src/repositories/address.repository.ts`
DB access via Prisma:
- Transactional operations for:
  - creating default addresses
  - switching default addresses
  - deleting default addresses while switching default
- Usage tracking update (`markAsUsed`).
- Also contains repository helpers for location tables (if/when location endpoints are implemented).

### `src/services/outbox.service.ts`
Outbox writer (stores events in `ServiceOutbox`).

### `src/utils/asyncHandler.ts`
Async handler wrapper to forward promise rejections to the centralized error handler.

### `scripts/copy-generated-prisma.mjs`
Build helper:
- Copies `src/generated/prisma` → `dist/generated/prisma` so runtime imports work when running `node dist/index.js`.

