// =============================================================================
// PAYMENT SERVICE DATABASE SCHEMA
// Service: payment-service (Port 3007)
// Database: payment_db
// Owner: Payments, refunds, payment methods, gateway logs
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("PAYMENT_DATABASE_URL")
}

// =============================================================================
// PAYMENTS
// =============================================================================

model Payment {
  id                   String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentNumber        String        @unique @map("payment_number") @db.VarChar(50) // PAY-20260115-XXXXX
  orderId              String        @map("order_id") @db.Uuid // Reference to Order Service
  userId               String        @map("user_id") @db.Uuid // Reference to Auth Service
  // Amounts
  amount               Decimal       @db.Decimal(15, 2)
  gatewayFee           Decimal       @default(0) @map("gateway_fee") @db.Decimal(15, 2)
  netAmount            Decimal       @map("net_amount") @db.Decimal(15, 2) // Amount - gatewayFee
  currency             String        @default("IDR") @db.VarChar(3)
  // Payment method
  paymentMethod        PaymentMethod @map("payment_method")
  paymentMethodDetail  String?       @map("payment_method_detail") @db.VarChar(100) // e.g., "BCA Virtual Account"
  // Gateway info (Xendit)
  paymentGateway       String        @default("xendit") @map("payment_gateway") @db.VarChar(50)
  gatewayTransactionId String?       @map("gateway_transaction_id") @db.VarChar(255)
  gatewayReferenceId   String?       @map("gateway_reference_id") @db.VarChar(255)
  gatewayInvoiceUrl    String?       @map("gateway_invoice_url")
  // Virtual account / payment details
  virtualAccountNumber String?       @map("virtual_account_number") @db.VarChar(50)
  qrCodeUrl            String?       @map("qr_code_url")
  paymentCode          String?       @map("payment_code") @db.VarChar(50)
  // Status
  status               PaymentStatus @default(pending)
  failureReason        String?       @map("failure_reason") @db.VarChar(500)
  failureCode          String?       @map("failure_code") @db.VarChar(100)
  // Timestamps
  expiresAt            DateTime?     @map("expires_at") @db.Timestamptz(6)
  paidAt               DateTime?     @map("paid_at") @db.Timestamptz(6)
  cancelledAt          DateTime?     @map("cancelled_at") @db.Timestamptz(6)
  // Wallet payment (if applicable)
  walletId             String?       @map("wallet_id") @db.Uuid
  walletTransactionId  String?       @map("wallet_transaction_id") @db.Uuid
  // Idempotency
  idempotencyKey       String        @unique @map("idempotency_key") @db.VarChar(100)
  // Metadata
  metadata             Json?
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  gatewayLogs PaymentGatewayLog[]
  refunds     Refund[]

  @@index([paymentNumber])
  @@index([orderId])
  @@index([userId])
  @@index([gatewayTransactionId])
  @@index([status])
  @@index([createdAt])
  @@map("payment")
}

// =============================================================================
// PAYMENT GATEWAY LOGS (Audit trail for Xendit API calls)
// =============================================================================

model PaymentGatewayLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentId       String?  @map("payment_id") @db.Uuid
  refundId        String?  @map("refund_id") @db.Uuid
  // Request details
  action          String   @db.VarChar(100) // "create_invoice", "get_payment", etc.
  requestMethod   String   @map("request_method") @db.VarChar(10)
  requestUrl      String   @map("request_url") @db.VarChar(500)
  requestBody     Json?    @map("request_body")
  requestHeaders  Json?    @map("request_headers")
  // Response details
  responseStatus  Int?     @map("response_status")
  responseBody    Json?    @map("response_body")
  responseHeaders Json?    @map("response_headers")
  // Timing
  durationMs      Int?     @map("duration_ms")
  // Error tracking
  errorMessage    String?  @map("error_message")
  errorCode       String?  @map("error_code") @db.VarChar(100)
  // Webhook info (if applicable)
  isWebhook       Boolean  @default(false) @map("is_webhook")
  webhookType     String?  @map("webhook_type") @db.VarChar(100)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  refund  Refund?  @relation(fields: [refundId], references: [id], onDelete: SetNull)

  @@index([paymentId])
  @@index([refundId])
  @@index([createdAt])
  @@map("payment_gateway_log")
}

// =============================================================================
// REFUNDS
// =============================================================================

model Refund {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  refundNumber    String       @unique @map("refund_number") @db.VarChar(50) // REF-20260115-XXXXX
  paymentId       String       @map("payment_id") @db.Uuid
  orderId         String       @map("order_id") @db.Uuid // Reference to Order Service
  returnId        String?      @map("return_id") @db.Uuid // Reference to Order Service Return
  userId          String       @map("user_id") @db.Uuid
  // Amounts
  amount          Decimal      @db.Decimal(15, 2)
  currency        String       @default("IDR") @db.VarChar(3)
  // Refund method
  refundMethod    RefundMethod @map("refund_method")
  // Gateway info
  gatewayRefundId String?      @map("gateway_refund_id") @db.VarChar(255)
  // Status
  status          RefundStatus @default(pending)
  failureReason   String?      @map("failure_reason") @db.VarChar(500)
  // Details
  reason          String?      @db.VarChar(500)
  notes           String?
  // Timestamps
  approvedAt      DateTime?    @map("approved_at") @db.Timestamptz(6)
  approvedBy      String?      @map("approved_by") @db.Uuid
  processedAt     DateTime?    @map("processed_at") @db.Timestamptz(6)
  completedAt     DateTime?    @map("completed_at") @db.Timestamptz(6)
  rejectedAt      DateTime?    @map("rejected_at") @db.Timestamptz(6)
  rejectedBy      String?      @map("rejected_by") @db.Uuid
  rejectionReason String?      @map("rejection_reason") @db.VarChar(500)
  // Idempotency
  idempotencyKey  String       @unique @map("idempotency_key") @db.VarChar(100)
  createdBy       String?      @map("created_by") @db.Uuid
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  payment     Payment             @relation(fields: [paymentId], references: [id])
  gatewayLogs PaymentGatewayLog[]

  @@index([refundNumber])
  @@index([paymentId])
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("refund")
}

// =============================================================================
// SAVED PAYMENT METHODS
// =============================================================================

model SavedPaymentMethod {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String        @map("user_id") @db.Uuid
  paymentMethod    PaymentMethod @map("payment_method")
  // Card details (tokenized)
  cardType         String?       @map("card_type") @db.VarChar(20) // visa, mastercard
  cardLast4        String?       @map("card_last4") @db.VarChar(4)
  cardExpMonth     Int?          @map("card_exp_month")
  cardExpYear      Int?          @map("card_exp_year")
  cardholderName   String?       @map("cardholder_name") @db.VarChar(255)
  gatewayTokenId   String?       @map("gateway_token_id") @db.VarChar(255) // Xendit card token
  // Bank account details
  bankCode         String?       @map("bank_code") @db.VarChar(20)
  bankAccountLast4 String?       @map("bank_account_last4") @db.VarChar(4)
  // Ewallet
  ewalletType      String?       @map("ewallet_type") @db.VarChar(50) // ovo, gopay, dana
  ewalletPhone     String?       @map("ewallet_phone") @db.VarChar(20)
  // Display
  displayName      String?       @map("display_name") @db.VarChar(100)
  isDefault        Boolean       @default(false) @map("is_default")
  // Status
  isActive         Boolean       @default(true) @map("is_active")
  lastUsedAt       DateTime?     @map("last_used_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime?     @map("deleted_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("saved_payment_method")
}

// =============================================================================
// DAILY SETTLEMENT RECORDS
// =============================================================================

model SettlementRecord {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  settlementDate DateTime  @map("settlement_date") @db.Date
  paymentGateway String    @map("payment_gateway") @db.VarChar(50)
  // Totals
  totalPayments  Int       @map("total_payments")
  totalAmount    Decimal   @map("total_amount") @db.Decimal(15, 2)
  totalFees      Decimal   @map("total_fees") @db.Decimal(15, 2)
  netAmount      Decimal   @map("net_amount") @db.Decimal(15, 2)
  // Refunds
  totalRefunds   Int       @map("total_refunds")
  refundAmount   Decimal   @map("refund_amount") @db.Decimal(15, 2)
  // Status
  isReconciled   Boolean   @default(false) @map("is_reconciled")
  reconciledAt   DateTime? @map("reconciled_at") @db.Timestamptz(6)
  reconciledBy   String?   @map("reconciled_by") @db.Uuid
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([settlementDate, paymentGateway])
  @@index([settlementDate])
  @@map("settlement_record")
}

// =============================================================================
// COMMISSION LEDGER (0.5% commission tracking for social commerce)
// =============================================================================

model CommissionLedger {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ledgerNumber     String           @unique @map("ledger_number") @db.VarChar(50) // COM-20260115-XXXXX
  orderId          String           @map("order_id") @db.Uuid // Reference to Order Service
  orderNumber      String           @map("order_number") @db.VarChar(50)
  sellerId         String           @map("seller_id") @db.Uuid // Reference to Seller Service
  paymentId        String?          @map("payment_id") @db.Uuid // Reference to Payment
  // Amounts
  orderAmount      Decimal          @map("order_amount") @db.Decimal(15, 2) // Total order amount from this seller
  commissionRate   Decimal          @map("commission_rate") @db.Decimal(5, 4)  // e.g., 0.0050 for 0.5%
  commissionAmount Decimal          @map("commission_amount") @db.Decimal(15, 2) // Calculated commission
  // Payout reference (when commission is deducted from seller payout)
  sellerPayoutId   String?          @map("seller_payout_id") @db.Uuid
  // Status
  status           CommissionStatus @default(pending)
  collectedAt      DateTime?        @map("collected_at") @db.Timestamptz(6)
  // Timestamps
  orderCompletedAt DateTime?        @map("order_completed_at") @db.Timestamptz(6) // Commission becomes collectible
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([orderId, sellerId]) // Prevent duplicate commission per seller per order
  @@index([orderId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("commission_ledger")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(100)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum PaymentMethod {
  bank_transfer
  virtual_account
  credit_card
  debit_card
  ewallet_ovo
  ewallet_gopay
  ewallet_dana
  ewallet_linkaja
  ewallet_shopeepay
  qris
  retail_outlet
  wallet // LAKOO wallet
}

enum PaymentStatus {
  pending
  awaiting_payment
  paid
  failed
  expired
  cancelled
  refunded
  partially_refunded
}

enum RefundMethod {
  original_payment // Refund to original payment method
  wallet           // Refund to LAKOO wallet
  bank_transfer    // Manual bank transfer
}

enum RefundStatus {
  pending
  approved
  processing
  completed
  failed
  rejected
}

enum CommissionStatus {
  pending           // Order not yet completed
  collectible       // Order completed, ready to collect
  collected         // Deducted from seller payout
  waived            // Commission waived (promo, etc.)
  refunded          // Order was refunded
}
